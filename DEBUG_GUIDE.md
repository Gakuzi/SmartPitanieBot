# Проект "Смарт Питание" (smartPit)

Это Telegram-бот, написанный на Google Apps Script, который помогает пользователям следить за своим питанием. Бот интегрирован с Google Sheets для хранения данных о меню, продуктах и планах готовки.

---

## Руководство по отладке "зависшего" Telegram-бота на Google Apps Script

Это руководство поможет систематически находить и устранять причину, по которой ваш Telegram-бот перестает отвечать, даже если в логах Google Apps Script нет очевидных ошибок.

### Шаг 1: Понять природу "зависания"

В 99% случаев бот не "зависает". Происходит **"тихий сбой"** — скрипт запускается, но либо сразу завершается из-за невидимой ошибки, либо идет по логической ветке, в которой нет команды отправить ответ пользователю.

### Шаг 2: Главный диагностический вопрос: есть ли логи?

Это первый и самый важный шаг, который делит проблему на две большие категории.

1.  Зайдите в **"Выполнения" (Executions)** вашего проекта в Apps Script.
2.  Отправьте команду боту.
3.  Посмотрите, появилась ли в списке новая запись о выполнении `doPost`.

*   **Если НЕТ новой записи:** Проблема находится **вне вашего кода**. Telegram не может достучаться до вашего скрипта. Переходите к **Сценарию А**.
*   **Если ДА, новая запись появилась:** Проблема **внутри вашего кода**. Скрипт запускается, но работает неправильно. Переходите к **Сценарию Б**.

---

### Сценарий А: Записей о выполнении `doPost` нет

**Причина:** Неправильная связь между Telegram и Google.

**Как решить:**

1.  **Развертывание (Deployment):** Любое изменение в коде требует нового развертывания.
    *   Нажмите **"Развертывание" -> "Новое развертывание"**.
    *   Убедитесь, что тип **"Веб-приложение"** и доступ **"Все"**.
    *   Нажмите **"Развернуть"**.

2.  **Обновление Вебхука (Webhook):** После каждого развертывания вы получаете **новый URL**. Telegram должен знать этот новый адрес.
    *   Скопируйте новый URL.
    *   Создайте и откройте в браузере ссылку:
      `https://api.telegram.org/bot<ВАШ_ТОКЕН>/setWebhook?url=<НОВЫЙ_URL_СКРИПТА>`
    *   Убедитесь, что браузер показал ответ: `{"ok":true,...}`.

---

### Сценарий Б: Запись о выполнении `doPost` есть, но бот молчит

**Причина:** В вашем коде происходит "тихий сбой".

**Как решить (отладка через Telegram):**

Используйте Telegram как консоль для вывода логов. Оберните весь код в `doPost` в конструкцию `try...catch`, которая в случае любой ошибки отправит ее текст вам в чат.

**1. Модифицируйте `doPost`:**

```javascript
function doPost(e) {
  let chatId; // Объявляем chatId здесь, чтобы он был доступен в catch
  try {
    // 1. Базовый парсинг, чтобы получить chatId
    const data = JSON.parse(e.postData.contents);
    chatId = data.message.chat.id;

    // 2. Отладочные "чекпоинты" для отслеживания выполнения
    sendText(chatId, 'DEBUG: Checkpoint 1 - Start');

    // ... ваша основная логика ...

    sendText(chatId, 'DEBUG: Checkpoint X - End of logic');

  } catch (err) {
    // 3. Ловушка для ошибок
    // Если что-то пошло не так, бот пришлет вам полное сообщение об ошибке.
    if (chatId) {
      sendText(chatId, `--- КРИТИЧЕСКАЯ ОШИБКА ---
Сообщение: ${err.message}
Стек: ${err.stack}`);
    } else {
      Logger.log(`FATAL ERROR: ${err.message}`);
    }
  }
}
```

**2. Анализируйте ответ бота:**

*   Если бот прислал **"КРИТИЧЕСКАЯ ОШИБКА"**, вы нашли проблему.
*   Если бот присылает **чекпоинты, но обрывается**, значит, ошибка находится между последним успешным чекпоинтом и следующим.

**3. Пример из нашей практики: "Зависшая" сессия**

Мы обнаружили, что у пользователя была сохранена сессия, которую код не умел обрабатывать (`awaitBudget`).

**Решение:** Всегда добавляйте блок `default` в обработчики состояний (`switch`). Этот блок должен сбрасывать "сломанное" состояние и информировать пользователя.

```javascript
function handleUserInput(chatId, input, session) {
  switch (session.awaitingInput) {
    // ... ваши case ...

    default:
      // Если мы попали сюда, значит, у сессии неизвестное состояние.
      clearSession(chatId); // Сбрасываем его
      sendText(chatId, 'Произошла ошибка. Ваше предыдущее действие отменено. Попробуйте снова.', getMenu(chatId));
      break;
  }
}
```
Это делает бота **самовосстанавливающимся** от логических тупиков.
