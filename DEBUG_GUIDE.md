# Руководство по отладке и устранению неполадок

Это руководство поможет систематически находить и устранять распространенные проблемы с ботом, включая "зависания" и ошибки, связанные с разрешениями.

---

## Часть 1: Общая отладка "зависшего" бота

Если бот перестал отвечать, в 99% случаев это не "зависание", а **"тихий сбой"** — скрипт либо не запускается, либо завершается, не отправив ответ.

### Шаг 1: Проверка логов выполнения

1.  Откройте проект в Google Apps Script.
2.  Перейдите в раздел **"Выполнения" (Executions)**.
3.  Отправьте команду боту и посмотрите, появилась ли новая запись о выполнении `doPost`.

*   **Если НЕТ новой записи:** Проблема во внешней связи (Telegram → Google). Переходите к **Сценарию А**.
*   **Если ДА, новая запись есть:** Проблема внутри вашего кода. Переходите к **Сценарию Б**.

### Сценарий А: Записи о выполнении `doPost` нет

**Причина:** Неправильно настроен Webhook. Telegram не может достучаться до вашего скрипта.

**Решение:**

1.  **Создайте новое развертывание:** Любое изменение кода требует нового развертывания для вступления в силу.
2.  **Обновите Webhook:** После развертывания вы получаете **новый URL**. Его нужно сообщить Telegram.
    *   Скопируйте URL веб-приложения.
    *   Сформируйте и выполните в браузере запрос:
      `https://api.telegram.org/bot<ВАШ_ТОКЕН>/setWebhook?url=<НОВЫЙ_URL_СКРИПТА>`
    *   Убедитесь, что получили ответ: `{"ok":true,...}`.

### Сценарий Б: Запись `doPost` есть, но бот молчит

**Причина:** Логическая ошибка в коде или неперехваченное исключение.

**Решение (Метод "Эхо-теста"):**

Этот метод позволяет быстро изолировать проблему.

1.  **Включите режим отладки:**
    *   В редакторе Apps Script перейдите в **Настройки проекта → Свойства скрипта**.
    *   Добавьте свойство `DEBUG_MODE` со значением `true`.
2.  **Проведите тест:** Отправьте любое сообщение боту.
3.  **Анализ результата:**
    *   **Если эхо РАБОТАЕТ:** Связь с Telegram в порядке. Проблема в основной логике кода (`1_main.js` и т.д.).
    *   **Если эхо НЕ РАБОТАЕТ:** Проблема в базовой конфигурации (токен, вебхук, разрешения).

--- 

## Часть 2: Устранение ошибок сервера и прав доступа

**Симптомы:**
*   Ошибка "We're sorry, a server error occurred".
*   Ошибка в логах: "You do not have permission to call..."
*   Превышено максимальное время выполнения.

Эти ошибки почти всегда связаны с разрешениями Google Cloud или квотами.

### Шаг 1: Проверка и включение API в Google Cloud Console

1.  **Откройте Google Cloud Console:** [console.cloud.google.com](https://console.cloud.google.com/)
2.  **Выберите правильный проект**, связанный с вашим скриптом.
3.  **Перейдите в APIs & Services → Library**.
4.  **Найдите и включите (Enable) следующие API:**
    *   Google Apps Script API
    *   Google Drive API
    *   Google Sheets API
    *   Google Cloud Logging API

### Шаг 2: Проверка `oauthScopes` в манифесте

Убедитесь, что в файле `appsscript.json` прописаны все необходимые области доступа:

```json
{
  "oauthScopes": [
    "https://www.googleapis.com/auth/script.scriptapp",
    "https://www.googleapis.com/auth/spreadsheets",
    "https://www.googleapis.com/auth/drive",
    "https://www.googleapis.com/auth/drive.file", // Важно для создания файлов
    "https://www.googleapis.com/auth/userinfo.email",
    "https://www.googleapis.com/auth/script.container.ui",
    "https://www.googleapis.com/auth/script.external_request"
  ]
}
```

### Шаг 3: Принудительный сброс и обновление разрешений

Если вы добавили новые `oauthScopes`, но Google не запрашивает разрешения, их нужно сбросить вручную.

1.  **Откройте страницу разрешений вашего аккаунта Google:** [myaccount.google.com/permissions](https://myaccount.google.com/permissions)
2.  **Найдите ваш проект** в списке приложений, имеющих доступ к вашему аккаунту.
3.  **Нажмите на проект и выберите "УДАЛИТЬ ДОСТУП"**.
4.  **Вернитесь в редактор Apps Script** и запустите любую функцию, требующую разрешений (например, `setupProjectInfrastructure`).
5.  **Предоставьте разрешения** в появившемся окне. Система запросит все права, указанные в `appsscript.json`.

### Шаг 4: Проверка логов в Google Cloud Console

Если проблема сохраняется, детальные логи можно найти в Cloud Console.

1.  **Перейдите в Logging → Logs Explorer**.
2.  **Используйте фильтр** для поиска ошибок, связанных с вашим проектом:
    ```
    resource.type="cloud_functions" 
    resource.labels.function_name="YOUR_FUNCTION_NAME"
    severity>=ERROR
    ```

### Полезные функции для диагностики

В проекте могут быть предусмотрены специальные функции для быстрой проверки:
*   `diagnosePermissions()`: Тестирует доступ к ключевым сервисам Google.
*   `checkBotStatus()`: Проверяет статус вебхука и основные настройки.
*   `testBasicFunctionality()`: Проверяет базовые возможности (ScriptProperties, Drive, Sheets, внешние запросы).