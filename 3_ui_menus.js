/**
 * @file 3_ui_menus.js
 * @description –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ UI, –º–µ–Ω—é –∏ –¥–∏–∞–ª–æ–≥–∞–º–∏ –≤ Google Sheets –∏ Telegram.
 */

// --- –ú–µ–Ω—é –≤ Google Sheets ---

/**
 * –°–æ–∑–¥–∞–µ—Ç –∫–∞—Å—Ç–æ–º–Ω–æ–µ –º–µ–Ω—é –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ Google Sheets.
 */
function createCustomMenu() {
  SpreadsheetApp.getUi()
    .createMenu('ü§ñ SmartPit –ë–æ—Ç')
    .addItem('üöÄ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ–±—Ö—É–∫–æ–º', 'showWebhookManagerDialog')
    .addSeparator()
    .addItem('üîë –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω Telegram', 'setTelegramToken')
    .addItem('üîë –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–ª—é—á Gemini', 'setGeminiApiKey')
    .addSeparator()
    .addItem('‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É', 'setupProjectInfrastructure')
    .addToUi();
}

// --- –î–∏–∞–ª–æ–≥–æ–≤—ã–µ –æ–∫–Ω–∞ –≤ Google Sheets ---

/**
 * –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∏–∞–ª–æ–≥–æ–≤–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤–µ–±—Ö—É–∫–æ–º.
 */
function showWebhookManagerDialog() {
  const html = HtmlService.createHtmlOutputFromFile('webhook_manager_dialog')
    .setWidth(700)
    .setHeight(550);
  SpreadsheetApp.getUi().showModalDialog(html, '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤–µ–±—Ö—É–∫–æ–º Telegram');
}

/**
 * –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –≤–µ–±—Ö—É–∫–∞ –∏ URL –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤–æ–≥–æ –æ–∫–Ω–∞.
 * @returns {object} - –û–±—ä–µ–∫—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å—Ç–∞—Ç—É—Å–µ –∏ URL.
 */
function getWebhookStatusForDialog() {
  const webAppUrl = ScriptApp.getService().getUrl();
  const webhookInfo = getTelegramWebhookInfo();
  return { ...webhookInfo, webAppUrl };
}

/**
 * –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –≤–µ–±—Ö—É–∫ –∏–∑ –¥–∏–∞–ª–æ–≥–æ–≤–æ–≥–æ –æ–∫–Ω–∞.
 * @param {string} url - URL –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–µ–±—Ö—É–∫–∞.
 * @returns {object} - –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏.
 */
function setWebhookFromDialog(url) {
  if (!url) {
    return { ok: false, description: "URL –Ω–µ –±—ã–ª –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω." };
  }
  return setTelegramWebhook(url);
}

/**
 * –£–¥–∞–ª—è–µ—Ç –≤–µ–±—Ö—É–∫ –∏–∑ –¥–∏–∞–ª–æ–≥–æ–≤–æ–≥–æ –æ–∫–Ω–∞.
 * @returns {object} - –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏.
 */
function deleteWebhookFromDialog() {
  return deleteTelegramWebhook();
}

/**
 * –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–æ–∫–µ–Ω Telegram.
 */
function setTelegramToken() {
  const ui = SpreadsheetApp.getUi();
  const response = ui.prompt(
    '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–æ–∫–µ–Ω–∞ Telegram',
    '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à —Ç–æ–∫–µ–Ω Telegram API:',
    ui.ButtonSet.OK_CANCEL
  );

  if (response.getSelectedButton() == ui.Button.OK) {
    const token = response.getResponseText().trim();
    if (token) {
      PropertiesService.getScriptProperties().setProperty('TELEGRAM_TOKEN', token);
      ui.alert('–¢–æ–∫–µ–Ω Telegram —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω.');
    } else {
      ui.alert('–¢–æ–∫–µ–Ω –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.');
    }
  }
}

/**
 * –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∫–ª—é—á Gemini API.
 */
function setGeminiApiKey() {
  const ui = SpreadsheetApp.getUi();
  const response = ui.prompt(
    '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Gemini API',
    '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à –∫–ª—é—á Google Gemini API:',
    ui.ButtonSet.OK_CANCEL
  );

  if (response.getSelectedButton() == ui.Button.OK) {
    const apiKey = response.getResponseText().trim();
    if (apiKey) {
      PropertiesService.getScriptProperties().setProperty('GEMINI_API_KEY', apiKey);
      ui.alert('–ö–ª—é—á Gemini API —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω.');
    } else {
      ui.alert('–ö–ª—é—á API –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.');
    }
  }
}