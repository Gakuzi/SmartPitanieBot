/**
 * @file AI_assistant.js
 * @description –ú–æ–¥—É–ª—å –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –¥–ª—è –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
 */

/**
 * –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞, –∑–∞–º–µ–Ω—è—é—â–∞—è DEBUG router
 * @param {Object} data - –î–∞–Ω–Ω—ã–µ –æ—Ç Telegram
 */
function aiAssistant(data) {
  try {
    let chatId = null;
    let messageText = '';
    let updateType = 'unknown';

    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ –∏–∑–≤–ª–µ–∫–∞–µ–º chatId
    if (data.message) {
      updateType = 'message';
      chatId = data.message.chat.id;
      
      if (data.message.text) {
        messageText = data.message.text;
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é
        addToConversationHistory(chatId, 'user', messageText);
        
        // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –ò–ò
        handleUserMessage(chatId, messageText, data.message.from);
        
      } else {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—Ä—É–≥–∏—Ö —Ç–∏–ø–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (—Ñ–æ—Ç–æ, –¥–æ–∫—É–º–µ–Ω—Ç—ã –∏ —Ç.–¥.)
        handleNonTextMessage(chatId, data.message);
      }
      
    } else if (data.callback_query) {
      updateType = 'callback_query';
      chatId = data.callback_query.from.id;
      
      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º callback query
      handleCallbackQuery(data.callback_query);
      
    } else if (data.edited_message) {
      updateType = 'edited_message';
      chatId = data.edited_message.chat.id;
      
      // –£–≤–µ–¥–æ–º–ª—è–µ–º –æ–± –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
      sendText(chatId, "–Ø –∑–∞–º–µ—Ç–∏–ª, —á—Ç–æ –≤—ã –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã —è –º–æ–≥ –≤–∞–º –ø–æ–º–æ—á—å.");
      
    } else {
      Logger.log('–ü–æ–ª—É—á–µ–Ω –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç Telegram');
      return;
    }

    Logger.log(`AI Assistant: –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ ${updateType} –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${chatId}`);

  } catch (error) {
    Logger.log(`–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ AI Assistant: ${error.message}\n–°—Ç–µ–∫: ${error.stack}`);
    
    // –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    if (chatId) {
      sendText(chatId, "–ü—Ä–æ–∏–∑–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.");
    }
  }
}

/**
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —á–µ—Ä–µ–∑ –ò–ò
 * @param {string|number} chatId - ID —á–∞—Ç–∞
 * @param {string} messageText - –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
 * @param {Object} fromUser - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
 */
function handleUserMessage(chatId, messageText, fromUser) {
  try {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä "–ø–µ—á–∞—Ç–∞–µ—Ç"
    sendChatAction(chatId, 'typing');
    
    // –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userProfile = getUserProfile(chatId);
    
    // –ï—Å–ª–∏ —ç—Ç–æ –∫–æ–º–∞–Ω–¥–∞ /start, –∑–∞–ø—É—Å–∫–∞–µ–º –æ–Ω–±–æ—Ä–¥–∏–Ω–≥
    if (messageText === '/start') {
      startAiOnboarding(chatId, fromUser, userProfile);
      return;
    }
    
    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø—Ä–æ—à–µ–ª –æ–Ω–±–æ—Ä–¥–∏–Ω–≥, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –µ–≥–æ
    if (!userProfile.onboardingCompleted) {
      continueOnboarding(chatId, messageText, userProfile);
      return;
    }
    
    // –û–±—ã—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ –ò–ò
    processMessageWithAI(chatId, messageText, userProfile);
    
  } catch (error) {
    Logger.log(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${chatId}: ${error.message}`);
    sendText(chatId, "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –≤–∞—à–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.");
  }
}

/**
 * –ó–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞ —Å –Ω–æ–≤—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
 * @param {string|number} chatId - ID —á–∞—Ç–∞
 * @param {Object} fromUser - –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏–∑ Telegram
 * @param {Object} userProfile - –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 */
function startAiOnboarding(chatId, fromUser, userProfile) {
  try {
    // –°–æ–∑–¥–∞–µ–º –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    onboardUser(chatId, fromUser);
    
    // –ï—Å–ª–∏ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥ —É–∂–µ –ø—Ä–æ–π–¥–µ–Ω, –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ–º –∫–∞–∫ —Å—Ç–∞—Ä–æ–≥–æ –∑–Ω–∞–∫–æ–º–æ–≥–æ
    if (userProfile.onboardingCompleted && userProfile.name) {
      const welcomeBackMessage = `–ü—Ä–∏–≤–µ—Ç, ${userProfile.name}! üòä\n\n–†–∞–¥ —Ç–µ–±—è —Å–Ω–æ–≤–∞ –≤–∏–¥–µ—Ç—å! –Ø —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –ø–∏—Ç–∞–Ω–∏—é.\n\n–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å —Å–µ–≥–æ–¥–Ω—è? –ú–æ–≥—É:\n‚Ä¢ –°–æ—Å—Ç–∞–≤–∏—Ç—å –ø–ª–∞–Ω –ø–∏—Ç–∞–Ω–∏—è\n‚Ä¢ –ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ä–µ—Ü–µ–ø—Ç—ã\n‚Ä¢ –ü–æ–º–æ—á—å —Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–æ–∫—É–ø–æ–∫\n‚Ä¢ –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –ø–∏—Ç–∞–Ω–∏–∏\n\n–ò–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø–æ–æ–±—â–∞–µ–º—Å—è! üí¨`;
      
      sendText(chatId, welcomeBackMessage);
      addToConversationHistory(chatId, 'assistant', welcomeBackMessage);
      return;
    }
    
    // –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –¥–ª—è –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userName = fromUser.first_name || fromUser.username || '–¥—Ä—É–≥';
    const onboardingMessage = `–ü—Ä–∏–≤–µ—Ç, ${userName}! üëã\n\n–Ø - —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –ø–∏—Ç–∞–Ω–∏—é –∏ –∑–¥–æ—Ä–æ–≤–æ–º—É –æ–±—Ä–∞–∑—É –∂–∏–∑–Ω–∏! ü§ñüçé\n\n–ú–µ–Ω—è –∑–æ–≤—É—Ç SmartPit, –∏ —è –ø–æ–º–æ–≥—É —Ç–µ–±–µ:\n‚Ä¢ –°–æ—Å—Ç–∞–≤–ª—è—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ –ø–ª–∞–Ω—ã –ø–∏—Ç–∞–Ω–∏—è\n‚Ä¢ –ü–æ–¥–±–∏—Ä–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç—ã –ø–æ —Ç–≤–æ–∏–º –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è–º\n‚Ä¢ –ü–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∫—É–ø–∫–∏ –∏ –±—é–¥–∂–µ—Ç\n‚Ä¢ –°–ª–µ–¥–∏—Ç—å –∑–∞ —Ç–≤–æ–∏–º–∏ —Ü–µ–ª—è–º–∏ –≤ –ø–∏—Ç–∞–Ω–∏–∏\n\n–î–∞–≤–∞–π –∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è! –ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç? –ò —Ä–∞—Å—Å–∫–∞–∂–∏ –Ω–µ–º–Ω–æ–≥–æ –æ —Å–µ–±–µ - —á—Ç–æ —Ç–µ–±—è –ø—Ä–∏–≤–µ–ª–æ –∫–æ –º–Ω–µ? üòä`;
    
    sendText(chatId, onboardingMessage);
    addToConversationHistory(chatId, 'assistant', onboardingMessage);
    
    // –ù–∞—á–∏–Ω–∞–µ–º –ø—Ä–æ—Ü–µ—Å—Å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
    updateUserProfileField(chatId, 'onboardingStep', 'name_and_intro');
    
  } catch (error) {
    Logger.log(`–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${chatId}: ${error.message}`);
    sendText(chatId, "–ü—Ä–∏–≤–µ—Ç! –ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–±–æ–ª—å—à–∞—è –æ—à–∏–±–∫–∞, –Ω–æ —è –≥–æ—Ç–æ–≤ —Å —Ç–æ–±–æ–π –æ–±—â–∞—Ç—å—Å—è. –†–∞—Å—Å–∫–∞–∂–∏, —á–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?");
  }
}

/**
 * –ü—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @param {string|number} chatId - ID —á–∞—Ç–∞
 * @param {string} messageText - –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @param {Object} userProfile - –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 */
function continueOnboarding(chatId, messageText, userProfile) {
  try {
    const history = getConversationHistory(chatId, 10);
    const currentStep = userProfile.onboardingStep || 'name_and_intro';
    
    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –ò–ò –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏ –∏ —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞
    const prompt = createOnboardingPrompt(currentStep, messageText, history, userProfile);
    
    // –ü–æ–ª—É—á–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –ò–ò
    const aiResponse = callGemini(prompt, { temperature: 0.8, maxTokens: 1500 });
    
    if (!aiResponse) {
      sendText(chatId, "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞ —Å –ò–ò. –î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏–º –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ - —Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–≤–æ–∏—Ö —Ü–µ–ª—è—Ö –≤ –ø–∏—Ç–∞–Ω–∏–∏.");
      return;
    }
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    sendText(chatId, aiResponse);
    addToConversationHistory(chatId, 'assistant', aiResponse);
    
    // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç –ò–ò –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    analyzeAndUpdateProfile(chatId, messageText, aiResponse, userProfile);
    
  } catch (error) {
    Logger.log(`–û—à–∏–±–∫–∞ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${chatId}: ${error.message}`);
    sendText(chatId, "–î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏–º –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ! –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–∏—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è—Ö –≤ –ø–∏—Ç–∞–Ω–∏–∏.");
  }
}

/**
 * –°–æ–∑–¥–∞–µ—Ç –ø—Ä–æ–º–ø—Ç –¥–ª—è –ò–ò –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
 * @param {string} currentStep - –¢–µ–∫—É—â–∏–π —à–∞–≥ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
 * @param {string} userMessage - –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @param {Array} history - –ò—Å—Ç–æ—Ä–∏—è –æ–±—â–µ–Ω–∏—è
 * @param {Object} userProfile - –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @returns {string} –ü—Ä–æ–º–ø—Ç –¥–ª—è –ò–ò
 */
function createOnboardingPrompt(currentStep, userMessage, history, userProfile) {
  const basePrompt = `–¢—ã - –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –ø–∏—Ç–∞–Ω–∏—é –ø–æ –∏–º–µ–Ω–∏ SmartPit. –¢—ã –ø—Ä–æ–≤–æ–¥–∏—à—å –∑–Ω–∞–∫–æ–º—Å—Ç–≤–æ —Å –Ω–æ–≤—ã–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.

–¢–í–û–Ø –¶–ï–õ–¨: –°–æ–±—Ä–∞—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –≤ –¥—Ä—É–∂–µ–ª—é–±–Ω–æ–π –º–∞–Ω–µ—Ä–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–≥–æ –ø–ª–∞–Ω–∞ –ø–∏—Ç–∞–Ω–∏—è.

–í–ê–ñ–ù–´–ï –ü–†–ò–ù–¶–ò–ü–´:
- –ë—É–¥—å –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º, –Ω–æ –Ω–µ –Ω–∞–≤—è–∑—á–∏–≤—ã–º
- –ó–∞–¥–∞–≤–∞–π –ø–æ 1-2 –≤–æ–ø—Ä–æ—Å–∞ –∑–∞ —Ä–∞–∑
- –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏, –Ω–æ —É–º–µ—Ä–µ–Ω–Ω–æ
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–≤–µ—á–∞–µ—Ç –∫—Ä–∞—Ç–∫–æ, –ø—Ä–æ—Å–∏ —É—Ç–æ—á–Ω–µ–Ω–∏—è
- –ê–¥–∞–ø—Ç–∏—Ä—É–π—Å—è –∫ —Å—Ç–∏–ª—é –æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–ò–ù–§–û–†–ú–ê–¶–ò–Ø –î–õ–Ø –°–ë–û–†–ê:
1. –ò–º—è –∏ –±–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
2. –í–æ–∑—Ä–∞—Å—Ç, –ø–æ–ª, —Ä–æ—Å—Ç, –≤–µ—Å
3. –¶–µ–ª–∏ (–ø–æ—Ö—É–¥–µ–Ω–∏–µ/–Ω–∞–±–æ—Ä –º–∞—Å—Å—ã/–ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ)
4. –£—Ä–æ–≤–µ–Ω—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
5. –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è –≤ –µ–¥–µ (–ª—é–±–∏–º—ã–µ/–Ω–µ–ª—é–±–∏–º—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã)
6. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è (–∞–ª–ª–µ—Ä–≥–∏–∏, –¥–∏–µ—Ç–∞)
7. –ë—é–¥–∂–µ—Ç –Ω–∞ –ø–∏—Ç–∞–Ω–∏–µ
8. –í—Ä–µ–º—è –Ω–∞ –≥–æ—Ç–æ–≤–∫—É

–¢–µ–∫—É—â–∏–π —à–∞–≥: ${currentStep}`;

  let contextPrompt = '';
  
  if (history.length > 0) {
    contextPrompt += '\n\n–ò–°–¢–û–†–ò–Ø –†–ê–ó–ì–û–í–û–†–ê:\n';
    history.forEach(msg => {
      contextPrompt += `${msg.role === 'user' ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' : '–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç'}: ${msg.message}\n`;
    });
  }
  
  contextPrompt += `\n\n–ù–û–í–û–ï –°–û–û–ë–©–ï–ù–ò–ï –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø: "${userMessage}"`;
  
  if (currentStep === 'name_and_intro') {
    contextPrompt += '\n\n–≠—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ—Å–ª–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è. –£–∑–Ω–∞–π –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —á—Ç–æ –µ–≥–æ –ø—Ä–∏–≤–µ–ª–æ –∫ —Ç–µ–±–µ. –ó–∞–¥–∞–π 1-2 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞ –æ –µ–≥–æ —Ü–µ–ª—è—Ö.';
  }
  
  contextPrompt += '\n\n–û–¢–í–ï–¢ –î–û–õ–ñ–ï–ù –ë–´–¢–¨:\n- –î—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º\n- –ù–µ –±–æ–ª–µ–µ 3-4 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π\n- –° 1-2 –≤–æ–ø—Ä–æ—Å–∞–º–∏ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –¥–∏–∞–ª–æ–≥–∞\n- –ë–µ–∑ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Ç–µ—Ä–º–∏–Ω–æ–≤\n\n–ï—Å–ª–∏ —Ç—ã —Å–æ–±—Ä–∞–ª –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –¥–ª—è –±–∞–∑–æ–≤–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è, –∑–∞–∫–æ–Ω—á–∏ —Ñ—Ä–∞–∑–æ–π: "–û–ù–ë–û–†–î–ò–ù–ì_–ó–ê–í–ï–†–®–ï–ù"';
  
  return basePrompt + contextPrompt;
}

/**
 * –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –ò–ò –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @param {string|number} chatId - ID —á–∞—Ç–∞
 * @param {string} userMessage - –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @param {string} aiResponse - –û—Ç–≤–µ—Ç –ò–ò
 * @param {Object} userProfile - –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 */
function analyzeAndUpdateProfile(chatId, userMessage, aiResponse, userProfile) {
  try {
    // –ü—Ä–æ—Å—Ç–æ–π –∞–Ω–∞–ª–∏–∑ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
    const message = userMessage.toLowerCase();
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ–≥–æ —É–ø–æ–º—è–Ω—É–ª)
    if (!userProfile.name && (message.includes('–º–µ–Ω—è –∑–æ–≤—É—Ç') || message.includes('—è ') || message.includes('–∏–º—è'))) {
      const nameMatch = userMessage.match(/(?:–º–µ–Ω—è –∑–æ–≤—É—Ç|—è|–∏–º—è|–∑–æ–≤—É—Ç –º–µ–Ω—è)\s+([–∞-—è—ë]+)/i);
      if (nameMatch) {
        updateUserProfileField(chatId, 'name', nameMatch[1]);
      }
    }
    
    // –ò–∑–≤–ª–µ–∫–∞–µ–º –≤–æ–∑—Ä–∞—Å—Ç
    const ageMatch = message.match(/(\d{1,2})\s*(?:–ª–µ—Ç|–≥–æ–¥|–≥–æ–¥–∞)/);
    if (ageMatch) {
      updateUserProfileField(chatId, 'age', parseInt(ageMatch[1]));
    }
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–µ–ª—å
    if (message.includes('–ø–æ—Ö—É–¥') || message.includes('—Å–±—Ä–æ—Å–∏—Ç—å') || message.includes('—Å–Ω–∏–∑–∏—Ç—å –≤–µ—Å')) {
      updateUserProfileField(chatId, 'goal', '–ø–æ—Ö—É–¥–µ–Ω–∏–µ');
    } else if (message.includes('–Ω–∞–±—Ä–∞—Ç—å') || message.includes('–ø–æ–ø—Ä–∞–≤') || message.includes('–º–∞—Å—Å—É')) {
      updateUserProfileField(chatId, 'goal', '–Ω–∞–±–æ—Ä –º–∞—Å—Å—ã');
    } else if (message.includes('–ø–æ–¥–¥–µ—Ä–∂') || message.includes('—Å–æ—Ö—Ä–∞–Ω')) {
      updateUserProfileField(chatId, 'goal', '–ø–æ–¥–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–µ—Å–∞');
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∑–∞–≤–µ—Ä—à–µ–Ω –ª–∏ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥
    if (aiResponse.includes('–û–ù–ë–û–†–î–ò–ù–ì_–ó–ê–í–ï–†–®–ï–ù')) {
      updateUserProfileField(chatId, 'onboardingCompleted', true);
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
      const finalMessage = `–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å —è –∑–Ω–∞—é –æ —Ç–µ–±–µ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, —á—Ç–æ–±—ã —Å—Ç–∞—Ç—å —Ç–≤–æ–∏–º –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–º –ø–æ–º–æ—â–Ω–∏–∫–æ–º –ø–æ –ø–∏—Ç–∞–Ω–∏—é! üéâ\n\n–Ø –≥–æ—Ç–æ–≤ –ø–æ–º–æ—á—å —Ç–µ–±–µ:\n‚Ä¢ –°–æ—Å—Ç–∞–≤–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–µ –º–µ–Ω—é\n‚Ä¢ –ü–æ–¥–æ–±—Ä–∞—Ç—å —Ä–µ—Ü–µ–ø—Ç—ã\n‚Ä¢ –°–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∫—É–ø–∫–∏\n‚Ä¢ –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –ø–∏—Ç–∞–Ω–∏–∏\n\n–ß—Ç–æ —Ö–æ—á–µ—à—å –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø–µ—Ä–≤—ã–º? üòä`;
      
      sendText(chatId, finalMessage);
      addToConversationHistory(chatId, 'assistant', finalMessage);
    }
    
  } catch (error) {
    Logger.log(`–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${chatId}: ${error.message}`);
  }
}

/**
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –æ–±—ã—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è —á–µ—Ä–µ–∑ –ò–ò –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
 * @param {string|number} chatId - ID —á–∞—Ç–∞
 * @param {string} messageText - –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
 * @param {Object} userProfile - –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 */
function processMessageWithAI(chatId, messageText, userProfile) {
  try {
    const history = getConversationHistory(chatId, 5);
    
    const prompt = `–¢—ã - –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –ø–∏—Ç–∞–Ω–∏—é SmartPit –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userProfile.name || '–¥—Ä—É–≥'}.

–ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï:
- –ò–º—è: ${userProfile.name || '–Ω–µ —É–∫–∞–∑–∞–Ω–æ'}
- –í–æ–∑—Ä–∞—Å—Ç: ${userProfile.age || '–Ω–µ —É–∫–∞–∑–∞–Ω'}
- –¶–µ–ª—å: ${userProfile.goal || '–Ω–µ —É–∫–∞–∑–∞–Ω–∞'}
- –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è: ${userProfile.dietType || '–æ–±—ã—á–Ω–æ–µ –ø–∏—Ç–∞–Ω–∏–µ'}
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è: ${userProfile.allergies ? userProfile.allergies.join(', ') : '–Ω–µ—Ç'}

–¢–í–û–ò –í–û–ó–ú–û–ñ–ù–û–°–¢–ò:
- –°–æ–≤–µ—Ç—ã –ø–æ –ø–∏—Ç–∞–Ω–∏—é
- –†–µ—Ü–µ–ø—Ç—ã –∏ –ø–ª–∞–Ω—ã –ø–∏—Ç–∞–Ω–∏—è
- –ü–æ–º–æ—â—å —Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø–æ–∫—É–ø–æ–∫
- –û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –∑–¥–æ—Ä–æ–≤–æ–º –ø–∏—Ç–∞–Ω–∏–∏
- –ú–æ—Ç–∏–≤–∞—Ü–∏—è –∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∞

–ò–°–¢–û–†–ò–Ø –†–ê–ó–ì–û–í–û–†–ê:
${history.map(msg => `${msg.role === 'user' ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' : '–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç'}: ${msg.message}`).join('\n')}

–ù–û–í–û–ï –°–û–û–ë–©–ï–ù–ò–ï: "${messageText}"

–û—Ç–≤–µ—á–∞–π –¥—Ä—É–∂–µ–ª—é–±–Ω–æ, –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ –∏ –ø–æ–º–æ–≥–∞–π –¥–æ—Å—Ç–∏–≥–∞—Ç—å —Ü–µ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ —É–º–µ—Ä–µ–Ω–Ω–æ. –ï—Å–ª–∏ –Ω—É–∂–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è - —Å–ø—Ä–∞—à–∏–≤–∞–π.`;

    const aiResponse = callGemini(prompt, { temperature: 0.7, maxTokens: 1000 });
    
    if (aiResponse) {
      sendText(chatId, aiResponse);
      addToConversationHistory(chatId, 'assistant', aiResponse);
    } else {
      sendText(chatId, "–ò–∑–≤–∏–Ω–∏—Ç–µ, —É –º–µ–Ω—è –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã —Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –≤–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥.");
    }
    
  } catch (error) {
    Logger.log(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –ò–ò –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${chatId}: ${error.message}`);
    sendText(chatId, "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –≤–∞—à –≤–æ–ø—Ä–æ—Å.");
  }
}

/**
 * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–µ—Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
 * @param {string|number} chatId - ID —á–∞—Ç–∞
 * @param {Object} message - –û–±—ä–µ–∫—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
 */
function handleNonTextMessage(chatId, message) {
  try {
    let responseText = '';
    
    if (message.photo) {
      responseText = "–°–ø–∞—Å–∏–±–æ –∑–∞ —Ñ–æ—Ç–æ! üì∑ –í –±—É–¥—É—â–µ–º —è —Å–º–æ–≥—É –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –±–ª—é–¥ –∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤. –ê –ø–æ–∫–∞ —Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–º, —á—Ç–æ –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?";
    } else if (message.voice) {
      responseText = "–Ø –ø–æ–ª—É—á–∏–ª –≤–∞—à–µ –≥–æ–ª–æ—Å–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ! üé§ –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –ø–æ–∫–∞ —è –Ω–µ —É–º–µ—é –∏—Ö –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å, –Ω–æ —Å–∫–æ—Ä–æ –Ω–∞—É—á—É—Å—å. –ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–º, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞.";
    } else if (message.document) {
      responseText = "–í—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç! üìÑ –ü–æ–∫–∞ —è –Ω–µ —É–º–µ—é –∏—Ö –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å, –Ω–æ –≤ –±—É–¥—É—â–µ–º —Å–º–æ–≥—É –ø–æ–º–æ—á—å —Å –∞–Ω–∞–ª–∏–∑–æ–º –ø–ª–∞–Ω–æ–≤ –ø–∏—Ç–∞–Ω–∏—è –∏ —Ä–µ—Ü–µ–ø—Ç–æ–≤.";
    } else if (message.sticker) {
      responseText = `–ö–ª–∞—Å—Å–Ω—ã–π —Å—Ç–∏–∫–µ—Ä! ${message.sticker.emoji || 'üòÑ'} –î–∞–≤–∞–π—Ç–µ –ª—É—á—à–µ –ø–æ–≥–æ–≤–æ—Ä–∏–º –æ –≤–∞—à–∏—Ö —Ü–µ–ª—è—Ö –≤ –ø–∏—Ç–∞–Ω–∏–∏!`;
    } else if (message.location) {
      responseText = "–°–ø–∞—Å–∏–±–æ –∑–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é! üìç –í –±—É–¥—É—â–µ–º —è —Å–º–æ–≥—É –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –±–ª—é–¥–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–µ—Å—Ç–Ω–æ–π –∫—É—Ö–Ω–∏ –∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤. –ê –ø–æ–∫–∞ —Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–∏—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è—Ö!";
    } else {
      responseText = "–ò–Ω—Ç–µ—Ä–µ—Å–Ω–æ! ü§î –Ø –ø–æ–∫–∞ —É—á—É—Å—å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Ä–∞–∑–Ω—ã–µ —Ç–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π. –ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–º, —á–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?";
    }
    
    sendText(chatId, responseText);
    addToConversationHistory(chatId, 'assistant', responseText);
    
  } catch (error) {
    Logger.log(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–µ—Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è ${chatId}: ${error.message}`);
    sendText(chatId, "–ü–æ–ª—É—á–∏–ª –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ! –ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç–æ–º, –∫–∞–∫ –º–æ–≥—É –ø–æ–º–æ—á—å?");
  }
}