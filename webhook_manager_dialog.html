<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body, html { 
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f8f9fa;
      color: #212529;
    }
    .container {
      max-width: 650px;
      margin: 0 auto;
    }
    h2 {
      color: #343a40;
      text-align: center;
      margin-bottom: 20px;
      font-weight: 700;
    }
    .status-panel {
        border-radius: 8px;
        margin-bottom: 15px;
        padding: 15px 20px;
        border-left: 5px solid;
        background-color: #fff;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    .status-panel.ok { border-color: #28a745; }
    .status-panel.warning { border-color: #ffc107; }
    .status-panel.critical { border-color: #dc3545; }
    .status-header {
        display: flex;
        align-items: center;
        font-size: 1.3em;
        font-weight: 500;
    }
    .status-icon { font-size: 1.4em; margin-right: 15px; }
    .status-panel.ok .status-header { color: #28a745; }
    .status-panel.warning .status-header { color: #ffc107; }
    .status-panel.critical .status-header { color: #dc3545; }

    details { margin-top: 15px; border-top: 1px solid #e9ecef; padding-top: 10px; }
    summary {
        font-size: 1.1em;
        color: #495057;
        font-weight: 500;
        cursor: pointer;
        outline: none;
    }

    .info-content p, .info-content pre {
        font-size: 0.95em;
        line-height: 1.6;
        color: #495057;
        white-space: pre-wrap;
        word-wrap: break-word;
        margin-top: 8px;
    }
    .info-content pre {
        background-color: #e9ecef;
        padding: 10px;
        border-radius: 5px;
        font-family: monospace;
    }
    .dev-links a { text-decoration: none; color: #007bff; font-weight: 500; }
    .dev-links a:hover { text-decoration: underline; }

    .url-section {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        margin-bottom: 15px;
    }
    .url-section strong { display: block; margin-bottom: 10px; color: #343a40; }
    .url-section p { line-height: 1.7; margin-top: 0; }
    .url-section input[type="text"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        box-sizing: border-box;
        font-size: 1em;
        margin-top: 10px;
    }

    .button-group {
      display: flex;
      justify-content: space-between;
      gap: 15px;
      margin-top: 20px;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 500;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .btn:hover { transform: translateY(-1px); }
    .btn-primary { background-color: #007bff; color: white; }
    .btn-danger { background-color: #dc3545; color: white; }
    .btn-secondary { background-color: #6c757d; color: white; }
    .btn-refresh { background-color: #17a2b8; color: white; }
    .btn-ai { background-color: #6f42c1; color: white; }

    .message { margin-top: 15px; padding: 12px; border-radius: 5px; text-align: center; font-weight: 500; }
    .message.success { background-color: #d4edda; color: #155724; }
    .message.error { background-color: #f8d7da; color: #721c24; }
    .hidden { display: none; }
    
    .loader-container { display: flex; align-items: center; justify-content: center; padding: 80px 40px; flex-direction: column; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 20px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .loader-status { font-size: 1.1em; color: #6c757d; font-weight: 500; }
  </style>
</head>
<body>
  <div id="root" class="container"></div>

  <script>
    const root = document.getElementById('root');
    let globalBasicInfo = {};

    function renderLoader(statusText) {
      root.innerHTML = `
        <div class="loader-container">
            <div class="spinner"></div>
            <div class="loader-status">${statusText}</div>
        </div>`;
    }

    function renderMainContent(data) {
      const { analysis, basicInfo } = data;
      const statusMap = { OK: {c: 'ok', i: '✅'}, WARNING: {c: 'warning', i: '⚠️'}, CRITICAL: {c: 'critical', i: '❌'} };
      const statusInfo = statusMap[analysis.status] || statusMap.CRITICAL;

      const devToolsHidden = analysis.status === 'OK' ? 'hidden' : '';
      const aiButtonHidden = analysis.status === 'OK' ? 'hidden' : '';

      root.innerHTML = `
        <h2>Анализатор статуса вебхука</h2>
        <div id="statusPanel" class="status-panel ${statusInfo.c}">
            <div class="status-header">
                <span class="status-icon">${statusInfo.i}</span>
                <span>${analysis.summary || 'Нет данных'}</span>
            </div>
            <details ${analysis.status !== 'OK' ? 'open' : ''}>
                <summary>Подробности</summary>
                <div class="info-content"><p>${(analysis.details || 'Нет данных').replace(/\n/g, '<br>')}</p></div>
            </details>
            <details ${analysis.status !== 'OK' ? 'open' : ''}>
                <summary>Решение</summary>
                <div class="info-content"><p>${(analysis.solution || 'Нет данных').replace(/\n/g, '<br>')}</p></div>
            </details>
            <details>
                <summary>Сырые данные от Telegram</summary>
                <div class="info-content"><pre>${JSON.stringify(basicInfo.rawInfo, null, 2)}</pre></div>
            </details>
            <details class="${devToolsHidden}" ${!devToolsHidden ? 'open' : ''}>
                <summary>Инструменты разработчика</summary>
                <div class="info-content dev-links"><a href="${basicInfo.editorUrl || '#'}" target="_blank">Открыть в Apps Script</a></div>
            </details>
        </div>

        <div class="url-section">
            <strong>URL Веб-приложения</strong>
            <p>Вставьте URL вашего веб-приложения и нажмите "Установить".</p>
            <input type="text" id="manualWebhookUrl" placeholder="https://script.google.com/macros/s/ваше_id/exec" value="">
        </div>

        <div class="button-group">
          <button class="btn btn-refresh" id="refreshBtn">Обновить</button>
          <button class="btn btn-ai ${aiButtonHidden}" id="aiAnalyzeBtn">AI-анализ</button>
          <button class="btn btn-primary" id="setWebhookBtn">Установить / Обновить</button>
          <button class="btn btn-danger" id="deleteWebhookBtn" style="display: ${basicInfo.rawInfo.url ? 'inline-block' : 'none'};">Удалить</button>
          <button class="btn btn-secondary" id="closeDialogBtn">Закрыть</button>
        </div>

        <div id="dialogMessage" class="message hidden"></div>`;
      
      bindEventListeners();
    }

    function bindEventListeners() {
      document.getElementById('refreshBtn').addEventListener('click', loadBasicInfo);
      const aiBtn = document.getElementById('aiAnalyzeBtn');
      if (aiBtn && !aiBtn.classList.contains('hidden')) {
        aiBtn.addEventListener('click', runAiAnalysis);
      }
      document.getElementById('setWebhookBtn').addEventListener('click', () => {
        const url = document.getElementById('manualWebhookUrl').value.trim();
        if (!url) { showMessage('URL для установки не найден.', 'error'); return; }
        handleAction('setWebhookFromDialog', url);
      });
      const deleteBtn = document.getElementById('deleteWebhookBtn');
      if (deleteBtn) {
        deleteBtn.addEventListener('click', () => handleAction('deleteWebhookFromDialog'));
      }
      document.getElementById('closeDialogBtn').addEventListener('click', () => google.script.host.close());
    }

    function showMessage(msg, type) {
      const dialogMessage = document.getElementById('dialogMessage');
      if (dialogMessage) { dialogMessage.textContent = msg; dialogMessage.className = `message ${type}`; }
    }

    function handleFailure(error, context) {
        const errorAnalysis = { status: 'CRITICAL', summary: `Критическая ошибка: ${context}`, details: `Произошла непредвиденная ошибка: ${error.message}`, solution: 'Проверьте консоль браузера (F12) для деталей.' };
        renderMainContent({ analysis: errorAnalysis, basicInfo: globalBasicInfo });
    }

    function loadBasicInfo() {
        renderLoader('Получение базовой информации от Telegram...');
        google.script.run
            .withSuccessHandler(response => {
                globalBasicInfo = response.basicInfo || {};
                renderMainContent(response.ok ? response : { basicInfo: globalBasicInfo, analysis: { status: 'CRITICAL', summary: 'Ошибка ответа сервера', details: response.error } });
            })
            .withFailureHandler(err => handleFailure(err, 'Получение базовой информации'))
            .getBasicWebhookInfo();
    }

    function runAiAnalysis() {
        const manualUrl = document.getElementById('manualWebhookUrl').value.trim();
        if (!manualUrl) { showMessage('URL для анализа не найден.', 'error'); return; }
        renderLoader('Запуск AI-анализа... Это может занять до 30 секунд.');
        const analysisData = { ...globalBasicInfo, webAppUrl: manualUrl };
        google.script.run
            .withSuccessHandler(response => {
                if (response.ok) {
                    globalBasicInfo = response.basicInfo;
                    renderMainContent(response);
                } else {
                    handleFailure(new Error(response.error || 'Неизвестная ошибка AI'), 'AI-анализ');
                }
            })
            .withFailureHandler(err => handleFailure(err, 'AI-анализ'))
            .getAiAnalysis(analysisData);
    }

    function handleAction(actionFunction, ...args) {
        renderLoader('Выполнение операции на сервере...');
        google.script.run
            .withSuccessHandler(result => { loadBasicInfo(); })
            .withFailureHandler(err => handleFailure(err, 'Действие с вебхуком'))
            [actionFunction](...args);
    }

    document.addEventListener('DOMContentLoaded', loadBasicInfo);
  </script>
</body>
</html>
