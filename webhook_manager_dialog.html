<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f8f9fa;
      color: #212529;
    }
    .container {
      max-width: 650px;
      margin: 0 auto;
    }
    h2 {
      color: #343a40;
      text-align: center;
      margin-bottom: 25px;
      font-weight: 700;
    }
    .status-panel {
        border-radius: 8px;
        margin-bottom: 20px;
        padding: 20px;
        border-left: 5px solid;
        background-color: #fff;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }
    .status-panel.ok {
        border-color: #28a745;
    }
    .status-panel.warning {
        border-color: #ffc107;
    }
    .status-panel.critical {
        border-color: #dc3545;
    }
    .status-header {
        display: flex;
        align-items: center;
        font-size: 1.4em;
        font-weight: 500;
        margin-bottom: 15px;
    }
    .status-icon {
        font-size: 1.5em;
        margin-right: 15px;
    }
    .status-panel.ok .status-header { color: #28a745; }
    .status-panel.warning .status-header { color: #ffc107; }
    .status-panel.critical .status-header { color: #dc3545; }

    .info-section {
        margin-top: 15px;
    }
    .info-section h3 {
        font-size: 1.1em;
        color: #495057;
        margin-bottom: 8px;
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 5px;
    }
    .info-section p, .info-section pre {
        font-size: 0.95em;
        line-height: 1.6;
        color: #495057;
        white-space: pre-wrap;
        word-wrap: break-word;
    }
    .info-section pre {
        background-color: #e9ecef;
        padding: 10px;
        border-radius: 5px;
        font-family: monospace;
    }
    .dev-links a {
        display: inline-block;
        margin-right: 15px;
        text-decoration: none;
        color: #007bff;
        font-weight: 500;
    }
    .dev-links a:hover {
        text-decoration: underline;
    }

    .url-section {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        margin-bottom: 20px;
    }
    .url-section strong {
      display: block;
      margin-bottom: 10px;
      color: #343a40;
    }
    .url-section code {
        background-color: #e9ecef;
        padding: 3px 6px;
        border-radius: 4px;
        word-break: break-all;
        display: block;
        margin-bottom: 15px;
    }
    .url-section input[type="text"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        box-sizing: border-box;
        font-size: 1em;
    }
    .url-section input[type="text"]:focus {
        border-color: #80bdff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
    }

    .button-group {
      display: flex;
      justify-content: space-between;
      gap: 15px;
      margin-top: 25px;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
      font-weight: 500;
      transition: all 0.2s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .btn:hover { transform: translateY(-1px); }
    .btn-primary { background-color: #007bff; color: white; }
    .btn-primary:hover { background-color: #0056b3; }
    .btn-danger { background-color: #dc3545; color: white; }
    .btn-danger:hover { background-color: #c82333; }
    .btn-secondary { background-color: #6c757d; color: white; }
    .btn-secondary:hover { background-color: #5a6268; }
    .btn-refresh { background-color: #17a2b8; color: white; }
    .btn-refresh:hover { background-color: #117a8b; }
    .btn-ai { background-color: #6f42c1; color: white; }
    .btn-ai:hover { background-color: #5a32a3; }

    .message {
      margin-top: 20px;
      padding: 12px;
      border-radius: 5px;
      text-align: center;
      font-weight: 500;
    }
    .message.success { background-color: #d4edda; color: #155724; }
    .message.error { background-color: #f8d7da; color: #721c24; }
    .hidden { display: none; }
    
    .loader {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px;
        flex-direction: column;
    }
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin-bottom: 20px;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    #loaderStatus {
        font-size: 1.1em;
        color: #6c757d;
        font-weight: 500;
    }

  </style>
</head>
<body>
  <div class="container">
    <h2>–ê–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ –≤–µ–±—Ö—É–∫–∞</h2>

    <div id="loader" class="loader">
        <div class="spinner"></div>
        <div id="loaderStatus">–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è...</div>
    </div>

    <div id="mainContent" class="hidden">
        <div id="statusPanel" class="status-panel">
            <div class="status-header">
                <span id="statusIcon" class="status-icon"></span>
                <span id="statusSummary"></span>
            </div>
            <div class="info-section">
                <h3>–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏</h3>
                <p id="statusDetails"></p>
            </div>
            <div class="info-section">
                <h3>–†–µ—à–µ–Ω–∏–µ</h3>
                <p id="statusSolution"></p>
            </div>
            <div id="raw-data-section" class="info-section">
                <h3>–°—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç Telegram</h3>
                <pre id="rawTelegramData"></pre>
            </div>
            <div id="dev-links-section" class="info-section hidden">
                <h3>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞</h3>
                <div class="dev-links">
                    <a id="gas-editor-link" href="#" target="_blank">–û—Ç–∫—Ä—ã—Ç—å –≤ Apps Script</a>
                </div>
            </div>
        </div>

        <div class="url-section">
            <strong>URL –í–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</strong>
            <p>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π URL:</p>
            <code id="autoWebAppUrl">-</code>
            <p>–ï—Å–ª–∏ URL –≤—ã—à–µ –Ω–µ–≤–µ—Ä–µ–Ω –∏–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π, –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ —Å—é–¥–∞:</p>
            <input type="text" id="manualWebhookUrl" placeholder="https://script.google.com/macros/s/–≤–∞—à–µ_id/exec">
        </div>

        <div class="button-group">
          <button class="btn btn-refresh" id="refreshBtn">–û–±–Ω–æ–≤–∏—Ç—å</button>
          <button class="btn btn-ai" id="aiAnalyzeBtn">–ó–∞–ø—É—Å—Ç–∏—Ç—å AI-–∞–Ω–∞–ª–∏–∑</button>
          <button class="btn btn-primary" id="setWebhookBtn">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å / –û–±–Ω–æ–≤–∏—Ç—å</button>
          <button class="btn btn-danger" id="deleteWebhookBtn">–£–¥–∞–ª–∏—Ç—å</button>
          <button class="btn btn-secondary" id="closeDialogBtn">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>

        <div class="message hidden" id="dialogMessage"></div>
    </div>
  </div>

  <script>
    // --- DOM Elements ---
    const loader = document.getElementById('loader');
    const loaderStatus = document.getElementById('loaderStatus');
    const mainContent = document.getElementById('mainContent');
    const statusPanel = document.getElementById('statusPanel');
    const statusIcon = document.getElementById('statusIcon');
    const statusSummary = document.getElementById('statusSummary');
    const statusDetails = document.getElementById('statusDetails');
    const statusSolution = document.getElementById('statusSolution');
    const rawDataSection = document.getElementById('raw-data-section');
    const rawTelegramData = document.getElementById('rawTelegramData');
    const devLinksSection = document.getElementById('dev-links-section');
    const gasEditorLink = document.getElementById('gas-editor-link');
    const autoWebAppUrlElem = document.getElementById('autoWebAppUrl');
    const manualWebhookUrlInput = document.getElementById('manualWebhookUrl');
    const setWebhookBtn = document.getElementById('setWebhookBtn');
    const deleteWebhookBtn = document.getElementById('deleteWebhookBtn');
    const closeDialogBtn = document.getElementById('closeDialogBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const aiAnalyzeBtn = document.getElementById('aiAnalyzeBtn');
    const dialogMessage = document.getElementById('dialogMessage');

    // --- Global State ---
    let basicInfo = {};

    // --- Functions ---

    function showLoader(statusText) {
        loaderStatus.textContent = statusText;
        loader.classList.remove('hidden');
        mainContent.classList.add('hidden');
    }

    function hideLoader() {
        loader.classList.add('hidden');
        mainContent.classList.remove('hidden');
    }

    function showMessage(msg, type) {
      dialogMessage.textContent = msg;
      dialogMessage.className = `message ${type}`;
    }

    function updateStatusPanel(analysis) {
        statusPanel.className = 'status-panel'; // Reset classes
        devLinksSection.classList.add('hidden');

        if (!analysis) {
            analysis = { status: 'CRITICAL', summary: '–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∫–ª–∏–µ–Ω—Ç–∞', details: '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞.', solution: '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∏ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞.' };
        }

        const statusMap = {
            OK: { className: 'ok', icon: '‚úÖ' },
            WARNING: { className: 'warning', icon: '‚ö†Ô∏è' },
            CRITICAL: { className: 'critical', icon: '‚ùå' }
        };
        const statusInfo = statusMap[analysis.status] || statusMap.CRITICAL;

        statusPanel.classList.add(statusInfo.className);
        statusIcon.textContent = statusInfo.icon;
        statusSummary.textContent = analysis.summary || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
        statusDetails.innerHTML = (analysis.details || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö').replace(/\n/g, '<br>');
        statusSolution.innerHTML = (analysis.solution || '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö').replace(/\n/g, '<br>');

        if (analysis.status !== 'OK') {
            devLinksSection.classList.remove('hidden');
            gasEditorLink.href = basicInfo.editorUrl;
        }
    }

    function handleFailure(error, context) {
        const errorAnalysis = {
            status: 'CRITICAL',
            summary: `–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: ${context}`,
            details: `–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞: ${error.message}`,
            solution: '–≠—Ç–∞ –æ—à–∏–±–∫–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –Ω–∏–∂–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (F12) –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –∫—Ä–∞—Å–Ω—ã—Ö –æ—à–∏–±–æ–∫.'
        };
        updateStatusPanel(errorAnalysis);
        hideLoader();
    }

    function loadBasicInfo() {
        showLoader('–ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–∑–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ—Ç Telegram...');
        showMessage('', 'hidden');
        google.script.run
            .withSuccessHandler(response => {
                if (response.ok) {
                    basicInfo = response;
                    autoWebAppUrlElem.textContent = response.webAppUrl || "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å";
                    rawTelegramData.textContent = JSON.stringify(response.rawInfo, null, 2);
                    deleteWebhookBtn.style.display = response.rawInfo && response.rawInfo.url ? 'inline-block' : 'none';
                    statusPanel.classList.add('warning');
                    statusIcon.textContent = 'ü§î';
                    statusSummary.textContent = '–¢—Ä–µ–±—É–µ—Ç—Å—è –∞–Ω–∞–ª–∏–∑';
                    statusDetails.textContent = '–ë–∞–∑–æ–≤–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∞. –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π –∑–∞–ø—É—Å—Ç–∏—Ç–µ AI-–∞–Ω–∞–ª–∏–∑.';
                    statusSolution.textContent = '–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É \"–ó–∞–ø—É—Å—Ç–∏—Ç—å AI-–∞–Ω–∞–ª–∏–∑\" –Ω–∏–∂–µ.';
                } else {
                    handleFailure(new Error(response.error), '–ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–∑–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏');
                }
                hideLoader();
            })
            .withFailureHandler(err => handleFailure(err, '–ü–æ–ª—É—á–µ–Ω–∏–µ –±–∞–∑–æ–≤–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏'))
            .getBasicWebhookInfo();
    }

    function runAiAnalysis() {
        showLoader('–ó–∞–ø—É—Å–∫ AI-–∞–Ω–∞–ª–∏–∑–∞... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –¥–æ 30 —Å–µ–∫—É–Ω–¥.');
        google.script.run
            .withSuccessHandler(response => {
                if (response.ok) {
                    updateStatusPanel(response.analysis);
                } else {
                    updateStatusPanel(response.analysis); // Show warning from server
                }
                hideLoader();
            })
            .withFailureHandler(err => handleFailure(err, 'AI-–∞–Ω–∞–ª–∏–∑'))
            .getAiAnalysis(basicInfo);
    }

    function handleAction(actionFunction, ...args) {
        showLoader('–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ...');
        google.script.run
            .withSuccessHandler(result => {
                if (result.ok) {
                    showMessage('–û–ø–µ—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞! –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—é —Å—Ç–∞—Ç—É—Å...', 'success');
                } else {
                    showMessage(`–û—à–∏–±–∫–∞: ${result.description || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Å–µ—Ä–≤–µ—Ä–Ω–∞—è –æ—à–∏–±–∫–∞.'}`, 'error');
                }
                loadBasicInfo(); // Always reload basic info
            })
            .withFailureHandler(err => handleFailure(err, '–î–µ–π—Å—Ç–≤–∏–µ —Å –≤–µ–±—Ö—É–∫–æ–º'))
            [actionFunction](...args);
    }

    // --- Event Listeners ---
    setWebhookBtn.addEventListener('click', () => {
      const manualUrl = manualWebhookUrlInput.value.trim();
      const finalUrl = manualUrl || autoWebAppUrlElem.textContent;
      if (!finalUrl || finalUrl === '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å') {
          showMessage('URL –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω. –í–≤–µ–¥–∏—Ç–µ –µ–≥–æ –≤—Ä—É—á–Ω—É—é.', 'error');
          return;
      }
      handleAction('setWebhookFromDialog', finalUrl);
    });

    deleteWebhookBtn.addEventListener('click', () => handleAction('deleteWebhookFromDialog'));
    refreshBtn.addEventListener('click', loadBasicInfo);
    aiAnalyzeBtn.addEventListener('click', runAiAnalysis);
    closeDialogBtn.addEventListener('click', () => google.script.host.close());

    document.addEventListener('DOMContentLoaded', loadBasicInfo);
  </script>
</body>
</html>