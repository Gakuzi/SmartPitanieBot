<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartPit Console ‚Äî –¶–µ–Ω—Ç—Ä —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --warning: #fca311;
            --danger: #e63946;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #8d99ae;
            --gray-light: #edf2f4;
            --border-radius: 12px;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
    }

    body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
    }

    .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
    }

    .header {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: var(--primary);
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: var(--gray);
            font-size: 1.1rem;
        }

        .dashboard {
      display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 30px;
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .card-header {
      display: flex;
      align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--gray-light);
        }

        .card-header i {
            font-size: 2rem;
            color: var(--primary);
        }

        .card-header h3 {
            font-size: 1.5rem;
            color: var(--dark);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 5px;
    }

    .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, var(--success), #2F80ED);
        color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, var(--warning), #F5576C);
            color: white;
    }

    .btn-danger {
            background: linear-gradient(45deg, var(--danger), #C44569);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background: var(--success);
        }

        .status-offline {
            background: var(--danger);
        }

        .status-warning {
            background: var(--warning);
        }

        .log-container {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: var(--border-radius);
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--gray-light);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, var(--success), var(--primary));
            transition: width 0.3s ease;
        }

        /* Loading animations */
        .btn.loading { position: relative; opacity: 0.85; pointer-events: none; }
        .btn.loading:after {
            content: "";
            position: absolute;
            right: 12px;
            width: 16px; height: 16px;
            border: 2px solid rgba(255,255,255,0.6);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .progress-fill.loading {
            background: linear-gradient(90deg, var(--success), var(--primary));
            animation: progressPulse 1.2s ease-in-out infinite;
        }
        @keyframes progressPulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: var(--gray-light);
            border-radius: var(--border-radius);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--gray);
            margin-top: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: var(--border-radius);
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: var(--gray);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: var(--danger);
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid var(--gray-light);
            margin-bottom: 20px;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
        }

        .tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: 500;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
  </style>
</head>
<body>
  <div class="container">
        <div class="header">
            <h1><i class="fas fa-sliders"></i> SmartPit Console</h1>
            <p>–¶–µ–Ω—Ç—Ä —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç–æ–º, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è–º–∏ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π</p>
        </div>

        <div class="dashboard">
            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-stethoscope"></i>
                    <h3>–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h3>
                </div>
                <p>–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ø–æ–ª–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É –≤—Å–µ—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤ —Å–∏—Å—Ç–µ–º—ã</p>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="test-passed">0</div>
                        <div class="stat-label">–ü—Ä–æ–π–¥–µ–Ω–æ</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="test-failed">0</div>
                        <div class="stat-label">–ü—Ä–æ–≤–∞–ª–µ–Ω–æ</div>
                    </div>
                </div>
                <button id="btn-diagnostics" class="btn btn-primary" onclick="runSystemDiagnostics(this)">
                    <i class="fas fa-play"></i> –ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É
                </button>
                <button class="btn btn-success" onclick="showDiagnosticsResults()">
                    <i class="fas fa-chart-bar"></i> –†–µ–∑—É–ª—å—Ç–∞—Ç—ã
                </button>
            </div>

            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-database"></i>
                    <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π</h3>
                </div>
                <p>–°–æ–∑–¥–∞–Ω–∏–µ –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü –∏ –ø–∞–ø–æ–∫</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="infrastructure-progress" style="width: 0%"></div>
                </div>
                <button id="btn-setup-infra" class="btn btn-primary" onclick="setupCompleteInfrastructure()">
                    <i class="fas fa-cogs"></i> –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É
                </button>
                <button id="btn-restore-structure" class="btn btn-warning" onclick="restoreTableStructure()">
                    <i class="fas fa-undo"></i> –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É
                </button>
            </div>

            <!-- –°—Å—ã–ª–∫–∞ –Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞ (–≤—ã–Ω–µ—Å–µ–Ω –æ—Ç–¥–µ–ª—å–Ω–æ) -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-project-diagram"></i>
                    <h3>–ú–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞ (–æ—Ç–¥–µ–ª—å–Ω—ã–π –º–æ–¥—É–ª—å)</h3>
                </div>
                <p>–û—Ç–∫—Ä—ã—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ–µ –æ–∫–Ω–æ "–ú–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞" —Å —Ç–∞–π–º–ª–∞–π–Ω–æ–º, –∑–∞–¥–∞—á–∞–º–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π</p>
                <a class="btn btn-primary" href="?page=project-manager" target="_blank">
                    <i class="fas fa-up-right-from-square"></i> –û—Ç–∫—Ä—ã—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞
                </a>
            </div>

            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ Telegram Bot -->
            <div class="card">
                <div class="card-header">
                    <i class="fab fa-telegram"></i>
                    <h3>Telegram Bot</h3>
                </div>
                <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</p>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="users-count">0</div>
                        <div class="stat-label">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="messages-today">0</div>
                        <div class="stat-label">–°–æ–æ–±—â–µ–Ω–∏–π —Å–µ–≥–æ–¥–Ω—è</div>
                    </div>
                </div>
                <button id="btn-test-telegram" class="btn btn-primary" onclick="testTelegramAPI()">
                    <i class="fas fa-paper-plane"></i> –¢–µ—Å—Ç API
                </button>
                <button class="btn btn-warning" onclick="manageWebhook()">
                    <i class="fas fa-link"></i> Webhook
                </button>
            </div>

            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ AI –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-brain"></i>
                    <h3>AI –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</h3>
                </div>
                <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ AI —Ñ—É–Ω–∫—Ü–∏—è–º–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –¥–∞–Ω–Ω—ã—Ö</p>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="ai-requests">0</div>
                        <div class="stat-label">AI –∑–∞–ø—Ä–æ—Å–æ–≤</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="accuracy">0%</div>
                        <div class="stat-label">–¢–æ—á–Ω–æ—Å—Ç—å</div>
                    </div>
                </div>
                <button id="btn-test-ai" class="btn btn-primary" onclick="testGeminiAPI()">
                    <i class="fas fa-magic"></i> –¢–µ—Å—Ç AI
                </button>
                <button class="btn btn-success" onclick="showAnalytics()">
                    <i class="fas fa-chart-pie"></i> –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
                </button>
            </div>

            <!-- –ö–∞—Ä—Ç–æ—á–∫–∞ –ª–æ–≥–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-clipboard-list"></i>
                    <h3>–õ–æ–≥–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</h3>
                </div>
                <p>–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã</p>
                <div class="log-container" id="log-container">
                    <div>–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–±–æ—Ç–µ...</div>
                </div>
                <button class="btn btn-primary" onclick="refreshLogs()">
                    <i class="fas fa-sync"></i> –û–±–Ω–æ–≤–∏—Ç—å –ª–æ–≥–∏
                </button>
                <button class="btn btn-danger" onclick="clearLogs()">
                    <i class="fas fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å
                </button>
            </div>
      </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ -->
    <div id="diagnosticsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('diagnosticsModal')">&times;</span>
            <h2><i class="fas fa-stethoscope"></i> –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏</h2>
            <div id="diagnostics-results"></div>
      </div>
    </div>

    <!-- –ú–µ–Ω–µ–¥–∂–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞ –≤—ã–Ω–µ—Å–µ–Ω –≤ –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É (?page=project-manager) -->

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let diagnosticsResults = null;
        let projectData = null;

        // –§—É–Ω–∫—Ü–∏–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
        function setLoading(btnId, loading) {
            var btn = document.getElementById(btnId);
            if (!btn) return;
            if (loading) { 
                btn.classList.add('loading'); 
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ó–∞–≥—Ä—É–∑–∫–∞...';
            } else { 
                btn.classList.remove('loading'); 
                btn.disabled = false;
                btn.innerHTML = btn.getAttribute('data-original-text') || '–ó–∞–ø—É—Å—Ç–∏—Ç—å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É';
            }
        }

        function runSystemDiagnostics(btn) {
            var btnId = 'btn-diagnostics';
            var btnElement = document.getElementById(btnId);
            btnElement.setAttribute('data-original-text', btnElement.innerHTML);
            
            setLoading(btnId, true);
            addLog('üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã...');
            
            google.script.run
                .withSuccessHandler(function(results) {
                    diagnosticsResults = results;
                    updateDiagnosticsUI(results);
                    addLog('‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
                    setLoading(btnId, false);
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
                    updateCounters(results);
                })
                .withFailureHandler(function(error) {
                    addLog('‚ùå –û—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏: ' + error.message);
                    setLoading(btnId, false);
                })
                .runFullSystemTest();
        }

        function updateDiagnosticsUI(results) {
            if (!results || !results.tests) {
                addLog('‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏');
                return;
            }
            
            const passed = results.passed || 0;
            const failed = results.failed || 0;
            const total = results.tests ? results.tests.length : 0;
            
            document.getElementById('test-passed').textContent = passed;
            document.getElementById('test-failed').textContent = failed;
            
            const progressBar = document.getElementById('infrastructure-progress');
            const percentage = total > 0 ? (passed / total) * 100 : 0;
            progressBar.style.width = percentage + '%';
            progressBar.textContent = Math.round(percentage) + '%';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ü–≤–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
            if (percentage >= 80) {
                progressBar.className = 'progress-bar bg-success';
            } else if (percentage >= 60) {
                progressBar.className = 'progress-bar bg-warning';
            } else {
                progressBar.className = 'progress-bar bg-danger';
            }
            
            addLog(`üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã: ${passed}/${total} —Ç–µ—Å—Ç–æ–≤ –ø—Ä–æ—à–ª–∏`);
        }

        function updateCounters(results) {
            if (!results || !results.tests) return;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
            let userCount = 0;
            let messageCount = 0;
            let aiCount = 0;
            let accuracy = 85; // –ë–∞–∑–æ–≤–∞—è —Ç–æ—á–Ω–æ—Å—Ç—å
            
            results.tests.forEach(test => {
                if (test.name && test.name.includes('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏')) {
                    userCount = test.details ? parseInt(test.details.match(/\d+/)) || 0 : 0;
                }
                if (test.name && test.name.includes('–°–æ–æ–±—â–µ–Ω–∏—è')) {
                    messageCount = test.details ? parseInt(test.details.match(/\d+/)) || 0 : 0;
                }
                if (test.name && test.name.includes('AI')) {
                    aiCount = test.details ? parseInt(test.details.match(/\d+/)) || 0 : 0;
                }
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
            document.getElementById('total-users').textContent = userCount;
            document.getElementById('total-messages').textContent = messageCount;
            document.getElementById('ai-requests').textContent = aiCount;
            document.getElementById('accuracy').textContent = accuracy + '%';
            
            addLog(`üìà –°—á–µ—Ç—á–∏–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏=${userCount}, –°–æ–æ–±—â–µ–Ω–∏—è=${messageCount}, AI=${aiCount}`);
        }

        function showDiagnosticsResults() {
            if (!diagnosticsResults) {
                addLog('‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É');
                return;
            }
            
            const modal = document.getElementById('diagnosticsModal');
            const resultsDiv = document.getElementById('diagnostics-results');
            
            let html = '<div class="stats-grid">';
            html += '<div class="stat-item"><div class="stat-number">' + (diagnosticsResults.passed || 0) + '</div><div class="stat-label">–ü—Ä–æ–π–¥–µ–Ω–æ</div></div>';
            html += '<div class="stat-item"><div class="stat-number">' + (diagnosticsResults.failed || 0) + '</div><div class="stat-label">–ü—Ä–æ–≤–∞–ª–µ–Ω–æ</div></div>';
            html += '</div>';
            
            if (diagnosticsResults.tests) {
                html += '<h3>–î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã:</h3>';
                diagnosticsResults.tests.forEach(test => {
                    const status = test.passed ? '‚úÖ' : '‚ùå';
                    html += '<div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 8px;">';
                    html += '<strong>' + status + ' ' + test.name + '</strong><br>';
                    html += '<small>' + test.message + '</small>';
                    html += '</div>';
                });
            }
            
            resultsDiv.innerHTML = html;
            modal.style.display = 'block';
        }

        // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
        function setupCompleteInfrastructure() {
            setLoading('btn-setup-infra', true);
            var bar = document.getElementById('infrastructure-progress');
            bar.classList.add('loading');
            bar.style.width = '10%';
            addLog('üîß –ó–∞–ø—É—Å–∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã...');
            
            google.script.run
                .withSuccessHandler(function(results) {
                    addLog('‚úÖ –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∞');
                    if (results.created) {
                        results.created.forEach(item => addLog('‚ûï ' + item));
                    }
                    if (results.restored) {
                        results.restored.forEach(item => addLog('üîÑ ' + item));
                    }
                    bar.classList.remove('loading');
                    bar.style.width = '100%';
                    setLoading('btn-setup-infra', false);
                })
                .withFailureHandler(function(error) {
                    addLog('‚ùå –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏: ' + error.message);
                    bar.classList.remove('loading');
                    setLoading('btn-setup-infra', false);
                })
                .setupCompleteInfrastructure();
        }

        function restoreTableStructure() {
            setLoading('btn-restore-structure', true);
            var bar = document.getElementById('infrastructure-progress');
            bar.classList.add('loading');
            bar.style.width = '25%';
            addLog('üîÑ –ó–∞–ø—É—Å–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ç–∞–±–ª–∏—Ü...');
            
            google.script.run
                .withSuccessHandler(function(results) {
                    addLog('‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞');
                    if (results.restored) {
                        results.restored.forEach(item => addLog('üîÑ ' + item));
                    }
                    bar.classList.remove('loading');
                    bar.style.width = '100%';
                    setLoading('btn-restore-structure', false);
                })
                .withFailureHandler(function(error) {
                    addLog('‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: ' + error.message);
                    bar.classList.remove('loading');
                    setLoading('btn-restore-structure', false);
                })
                .restoreTableStructure();
        }

        // –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–æ–º

        function switchTab(tabName) {
            // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ –≤–∫–ª–∞–¥–∫–∏
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –≤–∫–ª–∞–¥–∫—É
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // –§—É–Ω–∫—Ü–∏–∏ Telegram Bot
        function testTelegramAPI() {
            setLoading('btn-test-telegram', true);
            addLog('üì° –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Telegram API...');
            
            google.script.run
                .withSuccessHandler(function(result) {
                    addLog('‚úÖ Telegram API —Ä–∞–±–æ—Ç–∞–µ—Ç');
                    setLoading('btn-test-telegram', false);
                })
                .withFailureHandler(function(error) {
                    addLog('‚ùå –û—à–∏–±–∫–∞ Telegram API: ' + error.message);
                    setLoading('btn-test-telegram', false);
                })
                .testTelegramAPI();
        }

        function manageWebhook() {
            addLog('üîó –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ Webhook...');
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        addLog('‚úÖ Webhook —Ä–∞–±–æ—Ç–∞–µ—Ç: ' + result.message);
                        if (result.url) {
                            addLog('üîó URL: ' + result.url);
                        }
                        if (result.details) {
                            addLog('üìã –î–µ—Ç–∞–ª–∏: ' + JSON.stringify(result.details, null, 2));
                        }
                    } else {
                        addLog('‚ùå –û—à–∏–±–∫–∞ Webhook: ' + result.error);
                    }
                })
                .withFailureHandler(function(error) {
                    addLog('‚ùå –û—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ Webhook: ' + error.message);
                })
                .getBasicWebhookInfo();
        }

        // –§—É–Ω–∫—Ü–∏–∏ AI –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
        function testGeminiAPI() {
            setLoading('btn-test-ai', true);
            addLog('üß† –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Gemini AI...');
            
      google.script.run
                .withSuccessHandler(function(result) {
                    addLog('‚úÖ Gemini AI —Ä–∞–±–æ—Ç–∞–µ—Ç');
                    setLoading('btn-test-ai', false);
                })
                .withFailureHandler(function(error) {
                    addLog('‚ùå –û—à–∏–±–∫–∞ Gemini AI: ' + error.message);
                    setLoading('btn-test-ai', false);
                })
                .testGeminiAPI();
        }

        function showAnalytics() {
            addLog('üìä –ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...');
            // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∫–æ–¥ –¥–ª—è –ø–æ–∫–∞–∑–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
        }

        // –§—É–Ω–∫—Ü–∏–∏ –ª–æ–≥–æ–≤
        function addLog(message) {
            const container = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            container.innerHTML += '<div>[' + timestamp + '] ' + message + '</div>';
            container.scrollTop = container.scrollHeight;
        }

        function refreshLogs() {
            addLog('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–æ–≥–æ–≤...');
            // –ó–¥–µ—Å—å –±—É–¥–µ—Ç –∫–æ–¥ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ª–æ–≥–æ–≤
        }

        function clearLogs() {
            document.getElementById('log-container').innerHTML = '<div>–õ–æ–≥–∏ –æ—á–∏—â–µ–Ω—ã...</div>';
        }

        // –§—É–Ω–∫—Ü–∏–∏ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –∏—Ö
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            addLog('üöÄ –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            addLog('üìä –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏...');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–∞–∑–æ–≤—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
            loadBasicStats();
        };

        function loadBasicStats() {
            addLog('üìä –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–∏—Å—Ç–µ–º—ã...');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            google.script.run
                .withSuccessHandler(function(userCount) {
                    document.getElementById('total-users').textContent = userCount || 0;
                    addLog(`üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${userCount || 0}`);
                })
                .withFailureHandler(function(error) {
                    addLog('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ' + error.message);
                    document.getElementById('total-users').textContent = '0';
                })
                .getUserCount();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π
            google.script.run
                .withSuccessHandler(function(messageCount) {
                    document.getElementById('total-messages').textContent = messageCount || 0;
                    addLog(`üí¨ –°–æ–æ–±—â–µ–Ω–∏–π: ${messageCount || 0}`);
                })
                .withFailureHandler(function(error) {
                    addLog('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π: ' + error.message);
                    document.getElementById('total-messages').textContent = '0';
                })
                .getMessageCount();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É AI –∑–∞–ø—Ä–æ—Å–æ–≤
            google.script.run
                .withSuccessHandler(function(aiCount) {
                    document.getElementById('ai-requests').textContent = aiCount || 0;
                    addLog(`üß† AI –∑–∞–ø—Ä–æ—Å–æ–≤: ${aiCount || 0}`);
                })
                .withFailureHandler(function(error) {
                    addLog('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ AI —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + error.message);
                    document.getElementById('ai-requests').textContent = '0';
                })
                .getAiRequestCount();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ—á–Ω–æ—Å—Ç—å AI
            google.script.run
                .withSuccessHandler(function(accuracy) {
                    document.getElementById('accuracy').textContent = (accuracy || 0) + '%';
                    addLog(`üéØ –¢–æ—á–Ω–æ—Å—Ç—å AI: ${accuracy || 0}%`);
                })
                .withFailureHandler(function(error) {
                    addLog('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ—á–Ω–æ—Å—Ç–∏: ' + error.message);
                    document.getElementById('accuracy').textContent = '0%';
                })
                .getAiAccuracy();
            
            addLog('‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
        }

        // –£–¥–∞–ª–µ–Ω—ã —Ñ—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–µ–∫—Ç–æ–º –∏–∑ –∫–æ–Ω—Å–æ–ª–∏
  </script>
</body>
</html>
