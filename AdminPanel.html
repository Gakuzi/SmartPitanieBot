<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartPit Console — Центр управления</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --warning: #fca311;
            --danger: #e63946;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #8d99ae;
            --gray-light: #edf2f4;
            --border-radius: 12px;
            --shadow: 0 10px 30px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
    }

    body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--dark);
            line-height: 1.6;
            min-height: 100vh;
    }

    .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
    }

    .header {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: var(--primary);
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: var(--gray);
            font-size: 1.1rem;
        }

        .dashboard {
      display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 30px;
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.15);
        }

        .card-header {
      display: flex;
      align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--gray-light);
        }

        .card-header i {
            font-size: 2rem;
            color: var(--primary);
        }

        .card-header h3 {
            font-size: 1.5rem;
            color: var(--dark);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: var(--transition);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin: 5px;
    }

    .btn-primary {
            background: linear-gradient(45deg, var(--primary), var(--primary-dark));
            color: white;
        }

        .btn-success {
            background: linear-gradient(45deg, var(--success), #2F80ED);
        color: white;
        }

        .btn-warning {
            background: linear-gradient(45deg, var(--warning), #F5576C);
            color: white;
    }

    .btn-danger {
            background: linear-gradient(45deg, var(--danger), #C44569);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online {
            background: var(--success);
        }

        .status-offline {
            background: var(--danger);
        }

        .status-warning {
            background: var(--warning);
        }

        .log-container {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: var(--border-radius);
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--gray-light);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, var(--success), var(--primary));
            transition: width 0.3s ease;
        }

        /* Loading animations */
        .btn.loading { position: relative; opacity: 0.85; pointer-events: none; }
        .btn.loading:after {
            content: "";
            position: absolute;
            right: 12px;
            width: 16px; height: 16px;
            border: 2px solid rgba(255,255,255,0.6);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        .progress-fill.loading {
            background: linear-gradient(90deg, var(--success), var(--primary));
            animation: progressPulse 1.2s ease-in-out infinite;
        }
        @keyframes progressPulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: var(--gray-light);
            border-radius: var(--border-radius);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--gray);
            margin-top: 5px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: var(--border-radius);
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: var(--gray);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: var(--danger);
        }

        .tabs {
            display: flex;
            border-bottom: 2px solid var(--gray-light);
            margin-bottom: 20px;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
        }

        .tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: 500;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
        }
  </style>
</head>
<body>
  <div class="container">
        <div class="header">
            <h1><i class="fas fa-sliders"></i> SmartPit Console</h1>
            <p>Центр управления ботом, интеграциями и диагностикой</p>
        </div>

        <div class="dashboard">
            <!-- Карточка диагностики системы -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-stethoscope"></i>
                    <h3>Диагностика системы</h3>
                </div>
                <p>Запустите полную диагностику всех компонентов системы</p>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="test-passed">0</div>
                        <div class="stat-label">Пройдено</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="test-failed">0</div>
                        <div class="stat-label">Провалено</div>
                    </div>
                </div>
                <button id="btn-diagnostics" class="btn btn-primary" onclick="runSystemDiagnostics(this)">
                    <i class="fas fa-play"></i> Запустить диагностику
                </button>
                <button class="btn btn-success" onclick="showDiagnosticsResults()">
                    <i class="fas fa-chart-bar"></i> Результаты
                </button>
            </div>

            <!-- Карточка управления инфраструктурой -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-database"></i>
                    <h3>Управление инфраструктурой</h3>
                </div>
                <p>Создание и восстановление структуры таблиц и папок</p>
                <div class="progress-bar">
                    <div class="progress-fill" id="infrastructure-progress" style="width: 0%"></div>
                </div>
                <button id="btn-setup-infra" class="btn btn-primary" onclick="setupCompleteInfrastructure()">
                    <i class="fas fa-cogs"></i> Настроить инфраструктуру
                </button>
                <button id="btn-restore-structure" class="btn btn-warning" onclick="restoreTableStructure()">
                    <i class="fas fa-undo"></i> Восстановить структуру
                </button>
            </div>

            <!-- Ссылка на менеджер проекта (вынесен отдельно) -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-project-diagram"></i>
                    <h3>Менеджер проекта (отдельный модуль)</h3>
                </div>
                <p>Открыть отдельное окно "Менеджер проекта" с таймлайном, задачами и аналитикой</p>
                <a class="btn btn-primary" href="?page=project-manager" target="_blank">
                    <i class="fas fa-up-right-from-square"></i> Открыть менеджер проекта
                </a>
            </div>

            <!-- Карточка Telegram Bot -->
            <div class="card">
                <div class="card-header">
                    <i class="fab fa-telegram"></i>
                    <h3>Telegram Bot</h3>
                </div>
                <p>Управление ботом и мониторинг активности</p>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="users-count">0</div>
                        <div class="stat-label">Пользователей</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="messages-today">0</div>
                        <div class="stat-label">Сообщений сегодня</div>
                    </div>
                </div>
                <button id="btn-test-telegram" class="btn btn-primary" onclick="testTelegramAPI()">
                    <i class="fas fa-paper-plane"></i> Тест API
                </button>
                <button class="btn btn-warning" onclick="manageWebhook()">
                    <i class="fas fa-link"></i> Webhook
                </button>
            </div>

            <!-- Карточка AI и аналитика -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-brain"></i>
                    <h3>AI и аналитика</h3>
                </div>
                <p>Управление AI функциями и аналитика данных</p>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="ai-requests">0</div>
                        <div class="stat-label">AI запросов</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" id="accuracy">0%</div>
                        <div class="stat-label">Точность</div>
                    </div>
                </div>
                <button id="btn-test-ai" class="btn btn-primary" onclick="testGeminiAPI()">
                    <i class="fas fa-magic"></i> Тест AI
                </button>
                <button class="btn btn-success" onclick="showAnalytics()">
                    <i class="fas fa-chart-pie"></i> Аналитика
                </button>
            </div>

            <!-- Карточка логи и мониторинг -->
            <div class="card">
                <div class="card-header">
                    <i class="fas fa-clipboard-list"></i>
                    <h3>Логи и мониторинг</h3>
                </div>
                <p>Просмотр логов и мониторинг системы</p>
                <div class="log-container" id="log-container">
                    <div>Система готова к работе...</div>
                </div>
                <button class="btn btn-primary" onclick="refreshLogs()">
                    <i class="fas fa-sync"></i> Обновить логи
                </button>
                <button class="btn btn-danger" onclick="clearLogs()">
                    <i class="fas fa-trash"></i> Очистить
                </button>
            </div>
      </div>
    </div>

    <!-- Модальное окно для результатов диагностики -->
    <div id="diagnosticsModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('diagnosticsModal')">&times;</span>
            <h2><i class="fas fa-stethoscope"></i> Результаты диагностики</h2>
            <div id="diagnostics-results"></div>
      </div>
    </div>

    <!-- Менеджер проекта вынесен в отдельную страницу (?page=project-manager) -->

    <script>
        // Глобальные переменные
        let diagnosticsResults = null;
        let projectData = null;

        // Функции диагностики
        function setLoading(btnId, loading) {
            var btn = document.getElementById(btnId);
            if (!btn) return;
            if (loading) { 
                btn.classList.add('loading'); 
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Загрузка...';
            } else { 
                btn.classList.remove('loading'); 
                btn.disabled = false;
                btn.innerHTML = btn.getAttribute('data-original-text') || 'Запустить диагностику';
            }
        }

        function runSystemDiagnostics(btn) {
            var btnId = 'btn-diagnostics';
            var btnElement = document.getElementById(btnId);
            btnElement.setAttribute('data-original-text', btnElement.innerHTML);
            
            setLoading(btnId, true);
            addLog('🚀 Запуск полной диагностики системы...');
            
            google.script.run
                .withSuccessHandler(function(results) {
                    diagnosticsResults = results;
                    updateDiagnosticsUI(results);
                    addLog('✅ Диагностика завершена');
                    setLoading(btnId, false);
                    
                    // Обновляем счетчики
                    updateCounters(results);
                })
                .withFailureHandler(function(error) {
                    addLog('❌ Ошибка диагностики: ' + error.message);
                    setLoading(btnId, false);
                })
                .runFullSystemTest();
        }

        function updateDiagnosticsUI(results) {
            if (!results || !results.tests) {
                addLog('❌ Некорректные результаты диагностики');
                return;
            }
            
            const passed = results.passed || 0;
            const failed = results.failed || 0;
            const total = results.tests ? results.tests.length : 0;
            
            document.getElementById('test-passed').textContent = passed;
            document.getElementById('test-failed').textContent = failed;
            
            const progressBar = document.getElementById('infrastructure-progress');
            const percentage = total > 0 ? (passed / total) * 100 : 0;
            progressBar.style.width = percentage + '%';
            progressBar.textContent = Math.round(percentage) + '%';
            
            // Обновляем цвет прогресс-бара
            if (percentage >= 80) {
                progressBar.className = 'progress-bar bg-success';
            } else if (percentage >= 60) {
                progressBar.className = 'progress-bar bg-warning';
            } else {
                progressBar.className = 'progress-bar bg-danger';
            }
            
            addLog(`📊 Результаты: ${passed}/${total} тестов прошли`);
        }

        function updateCounters(results) {
            if (!results || !results.tests) return;
            
            // Обновляем счетчики на основе результатов диагностики
            let userCount = 0;
            let messageCount = 0;
            let aiCount = 0;
            let accuracy = 85; // Базовая точность
            
            results.tests.forEach(test => {
                if (test.name && test.name.includes('Пользователи')) {
                    userCount = test.details ? parseInt(test.details.match(/\d+/)) || 0 : 0;
                }
                if (test.name && test.name.includes('Сообщения')) {
                    messageCount = test.details ? parseInt(test.details.match(/\d+/)) || 0 : 0;
                }
                if (test.name && test.name.includes('AI')) {
                    aiCount = test.details ? parseInt(test.details.match(/\d+/)) || 0 : 0;
                }
            });
            
            // Обновляем счетчики в интерфейсе
            document.getElementById('total-users').textContent = userCount;
            document.getElementById('total-messages').textContent = messageCount;
            document.getElementById('ai-requests').textContent = aiCount;
            document.getElementById('accuracy').textContent = accuracy + '%';
            
            addLog(`📈 Счетчики обновлены: Пользователи=${userCount}, Сообщения=${messageCount}, AI=${aiCount}`);
        }

        function showDiagnosticsResults() {
            if (!diagnosticsResults) {
                addLog('⚠️ Сначала запустите диагностику');
                return;
            }
            
            const modal = document.getElementById('diagnosticsModal');
            const resultsDiv = document.getElementById('diagnostics-results');
            
            let html = '<div class="stats-grid">';
            html += '<div class="stat-item"><div class="stat-number">' + (diagnosticsResults.passed || 0) + '</div><div class="stat-label">Пройдено</div></div>';
            html += '<div class="stat-item"><div class="stat-number">' + (diagnosticsResults.failed || 0) + '</div><div class="stat-label">Провалено</div></div>';
            html += '</div>';
            
            if (diagnosticsResults.tests) {
                html += '<h3>Детальные результаты:</h3>';
                diagnosticsResults.tests.forEach(test => {
                    const status = test.passed ? '✅' : '❌';
                    html += '<div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 8px;">';
                    html += '<strong>' + status + ' ' + test.name + '</strong><br>';
                    html += '<small>' + test.message + '</small>';
                    html += '</div>';
                });
            }
            
            resultsDiv.innerHTML = html;
            modal.style.display = 'block';
        }

        // Функции управления инфраструктурой
        function setupCompleteInfrastructure() {
            setLoading('btn-setup-infra', true);
            var bar = document.getElementById('infrastructure-progress');
            bar.classList.add('loading');
            bar.style.width = '10%';
            addLog('🔧 Запуск настройки полной инфраструктуры...');
            
            google.script.run
                .withSuccessHandler(function(results) {
                    addLog('✅ Инфраструктура настроена');
                    if (results.created) {
                        results.created.forEach(item => addLog('➕ ' + item));
                    }
                    if (results.restored) {
                        results.restored.forEach(item => addLog('🔄 ' + item));
                    }
                    bar.classList.remove('loading');
                    bar.style.width = '100%';
                    setLoading('btn-setup-infra', false);
                })
                .withFailureHandler(function(error) {
                    addLog('❌ Ошибка настройки: ' + error.message);
                    bar.classList.remove('loading');
                    setLoading('btn-setup-infra', false);
                })
                .setupCompleteInfrastructure();
        }

        function restoreTableStructure() {
            setLoading('btn-restore-structure', true);
            var bar = document.getElementById('infrastructure-progress');
            bar.classList.add('loading');
            bar.style.width = '25%';
            addLog('🔄 Запуск восстановления структуры таблиц...');
            
            google.script.run
                .withSuccessHandler(function(results) {
                    addLog('✅ Структура восстановлена');
                    if (results.restored) {
                        results.restored.forEach(item => addLog('🔄 ' + item));
                    }
                    bar.classList.remove('loading');
                    bar.style.width = '100%';
                    setLoading('btn-restore-structure', false);
                })
                .withFailureHandler(function(error) {
                    addLog('❌ Ошибка восстановления: ' + error.message);
                    bar.classList.remove('loading');
                    setLoading('btn-restore-structure', false);
                })
                .restoreTableStructure();
        }

        // Функции управления проектом

        function switchTab(tabName) {
            // Скрываем все вкладки
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Показываем выбранную вкладку
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Функции Telegram Bot
        function testTelegramAPI() {
            setLoading('btn-test-telegram', true);
            addLog('📡 Тестирование Telegram API...');
            
            google.script.run
                .withSuccessHandler(function(result) {
                    addLog('✅ Telegram API работает');
                    setLoading('btn-test-telegram', false);
                })
                .withFailureHandler(function(error) {
                    addLog('❌ Ошибка Telegram API: ' + error.message);
                    setLoading('btn-test-telegram', false);
                })
                .testTelegramAPI();
        }

        function manageWebhook() {
            addLog('🔗 Диагностика Webhook...');
            
            google.script.run
                .withSuccessHandler(function(result) {
                    if (result.success) {
                        addLog('✅ Webhook работает: ' + result.message);
                        if (result.url) {
                            addLog('🔗 URL: ' + result.url);
                        }
                        if (result.details) {
                            addLog('📋 Детали: ' + JSON.stringify(result.details, null, 2));
                        }
                    } else {
                        addLog('❌ Ошибка Webhook: ' + result.error);
                    }
                })
                .withFailureHandler(function(error) {
                    addLog('❌ Ошибка диагностики Webhook: ' + error.message);
                })
                .getBasicWebhookInfo();
        }

        // Функции AI и аналитики
        function testGeminiAPI() {
            setLoading('btn-test-ai', true);
            addLog('🧠 Тестирование Gemini AI...');
            
      google.script.run
                .withSuccessHandler(function(result) {
                    addLog('✅ Gemini AI работает');
                    setLoading('btn-test-ai', false);
                })
                .withFailureHandler(function(error) {
                    addLog('❌ Ошибка Gemini AI: ' + error.message);
                    setLoading('btn-test-ai', false);
                })
                .testGeminiAPI();
        }

        function showAnalytics() {
            addLog('📊 Загрузка аналитики...');
            // Здесь будет код для показа аналитики
        }

        // Функции логов
        function addLog(message) {
            const container = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            container.innerHTML += '<div>[' + timestamp + '] ' + message + '</div>';
            container.scrollTop = container.scrollHeight;
        }

        function refreshLogs() {
            addLog('🔄 Обновление логов...');
            // Здесь будет код для обновления логов
        }

        function clearLogs() {
            document.getElementById('log-container').innerHTML = '<div>Логи очищены...</div>';
        }

        // Функции модальных окон
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Закрытие модальных окон при клике вне их
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
        }

        // Инициализация при загрузке страницы
        window.onload = function() {
            addLog('🚀 Админ панель загружена');
            addLog('📊 Загрузка статистики...');
            
            // Загружаем базовую статистику
            loadBasicStats();
        };

        function loadBasicStats() {
            addLog('📊 Загрузка статистики системы...');
            
            // Загружаем статистику пользователей
            google.script.run
                .withSuccessHandler(function(userCount) {
                    document.getElementById('total-users').textContent = userCount || 0;
                    addLog(`👥 Пользователей: ${userCount || 0}`);
                })
                .withFailureHandler(function(error) {
                    addLog('❌ Ошибка загрузки пользователей: ' + error.message);
                    document.getElementById('total-users').textContent = '0';
                })
                .getUserCount();
            
            // Загружаем статистику сообщений
            google.script.run
                .withSuccessHandler(function(messageCount) {
                    document.getElementById('total-messages').textContent = messageCount || 0;
                    addLog(`💬 Сообщений: ${messageCount || 0}`);
                })
                .withFailureHandler(function(error) {
                    addLog('❌ Ошибка загрузки сообщений: ' + error.message);
                    document.getElementById('total-messages').textContent = '0';
                })
                .getMessageCount();
            
            // Загружаем статистику AI запросов
            google.script.run
                .withSuccessHandler(function(aiCount) {
                    document.getElementById('ai-requests').textContent = aiCount || 0;
                    addLog(`🧠 AI запросов: ${aiCount || 0}`);
                })
                .withFailureHandler(function(error) {
                    addLog('❌ Ошибка загрузки AI статистики: ' + error.message);
                    document.getElementById('ai-requests').textContent = '0';
                })
                .getAiRequestCount();
            
            // Загружаем точность AI
            google.script.run
                .withSuccessHandler(function(accuracy) {
                    document.getElementById('accuracy').textContent = (accuracy || 0) + '%';
                    addLog(`🎯 Точность AI: ${accuracy || 0}%`);
                })
                .withFailureHandler(function(error) {
                    addLog('❌ Ошибка загрузки точности: ' + error.message);
                    document.getElementById('accuracy').textContent = '0%';
                })
                .getAiAccuracy();
            
            addLog('✅ Статистика загружена');
        }

        // Удалены функции управления проектом из консоли
  </script>
</body>
</html>
