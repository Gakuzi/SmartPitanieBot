# üöÄ SmartPit v2: –ù–æ–≤–æ–µ –≤–∏–¥–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞

> **–¶–µ–ª—å**: –°–æ–∑–¥–∞—Ç—å —É–º–Ω–æ–≥–æ, –Ω–∞–¥—ë–∂–Ω–æ–≥–æ –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ–≥–æ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –¥–ª—è –ø–∏—Ç–∞–Ω–∏—è –∏ –ª–∏—á–Ω—ã—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤, —Ä–∞–±–æ—Ç–∞—é—â–µ–≥–æ —á–µ—Ä–µ–∑ Telegram –∏ Google –¢–∞–±–ª–∏—Ü—ã, —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º, –Ω–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –ò–ò.

---

## üîë –°–æ—Ö—Ä–∞–Ω—ë–Ω–Ω–∞—è –∏–¥–µ–æ–ª–æ–≥–∏—è

- ‚úÖ **–ü–æ–º–æ–≥–∞–µ—Ç –≤ –ø–∏—Ç–∞–Ω–∏–∏ –∏ –±—é–¥–∂–µ—Ç–µ** ‚Äî –æ–±–ª–µ–≥—á–∞–µ—Ç —Ä—É—Ç–∏–Ω—É.
- ‚úÖ **–î–∞–Ω–Ω—ã–µ –≤ Google –¢–∞–±–ª–∏—Ü–µ** ‚Äî –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å, –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è, –∫–æ–Ω—Ç—Ä–æ–ª—å.
- ‚úÖ **AI ‚Äî —Ç–æ–ª—å–∫–æ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏** ‚Äî –Ω–µ –¥–ª—è —Ä—É—Ç–∏–Ω—ã.
- ‚úÖ **–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å ‚Äî Telegram-–±–æ—Ç** ‚Äî —Å –∫–Ω–æ–ø–∫–∞–º–∏, –º–µ–Ω—é, —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏.
- ‚úÖ **–ú–∏–Ω–∏–º—É–º —Å–ª–æ–∂–Ω–æ—Å—Ç–µ–π** ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –¥–æ–ª–∂–µ–Ω –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å —Å–ª–æ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã.

---

## üîÑ –ß—Ç–æ –∏–∑–º–µ–Ω–µ–Ω–æ

| –ë—ã–ª–æ | –°—Ç–∞–ª–æ |
|------|-------|
| –õ–∏–Ω–µ–π–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ | –ú–æ–¥—É–ª—å–Ω–∞—è, —Å–æ–±—ã—Ç–∏–π–Ω–æ-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è |
| –ù–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º | –î–æ–±–∞–≤–ª–µ–Ω `state.js` –¥–ª—è —Å–µ—Å—Å–∏–π |
| –ñ—ë—Å—Ç–∫–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ –∫ AI | –ì–∏–±–∫–∏–π `ai/adapter.js` |
| –†—É—á–Ω–æ–π CRUD | –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π `sheets/crud.js` |
| –°–ª–æ–∂–Ω–æ–µ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ | –ü—Ä–æ—Å—Ç–æ–µ: –¥–æ–±–∞–≤—å –º–æ–¥—É–ª—å ‚Äî –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç |

---

## üß© –ù–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
SmartPit/
‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îú‚îÄ‚îÄ router.js            # –ï–¥–∏–Ω—ã–π —Ä–æ—É—Ç–µ—Ä –∫–æ–º–∞–Ω–¥ –∏ —Å–æ–±—ã—Ç–∏–π
‚îÇ   ‚îú‚îÄ‚îÄ state.js             # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚îÇ   ‚îî‚îÄ‚îÄ logger.js            # –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
‚îÇ
‚îú‚îÄ‚îÄ modules/
‚îÇ   ‚îú‚îÄ‚îÄ telegram/            # –†–∞–±–æ—Ç–∞ —Å Telegram
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ api.js           # –û—Ç–ø—Ä–∞–≤–∫–∞/–ø—Ä–∏—ë–º
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ keyboard.js      # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–Ω–æ–ø–æ–∫
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ sheets/              # –†–∞–±–æ—Ç–∞ —Å Google Sheets
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ crud.js          # –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π CRUD
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ schema.js        # –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü (Menu, Purchases, Budget)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ ai/                  # –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –ò–ò
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ prompt.js        # –ì–æ—Ç–æ–≤—ã–µ –ø—Ä–æ–º–ø—Ç—ã
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ adapter.js       # –û–±—ë—Ä—Ç–∫–∞ –¥–ª—è Gemini/OpenRouter
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ offline/             # –û—Ñ–ª–∞–π–Ω-–∫–æ–º–∞–Ω–¥—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ menu.js          # /get_menu
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ purchases.js     # /show_purchases
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ budget.js        # /my_budget
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ online/              # –û–Ω–ª–∞–π–Ω-–∫–æ–º–∞–Ω–¥—ã
‚îÇ       ‚îú‚îÄ‚îÄ generate_menu.js # /create_new_menu
‚îÇ       ‚îî‚îÄ‚îÄ ask_ai.js        # /ask_ai
‚îÇ
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ markdown.js          # –≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ MarkdownV2
‚îÇ   ‚îî‚îÄ‚îÄ helpers.js           # –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
‚îÇ
‚îú‚îÄ‚îÄ main.js                  # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ (doPost)
‚îú‚îÄ‚îÄ config.js                # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ (TOKEN, SHEET_ID)
‚îî‚îÄ‚îÄ PROJECT_PLAN.md          # –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª—è–µ–º—ã–π –ø–ª–∞–Ω
```

---

## üåê –°—Ö–µ–º–∞ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è –º–æ–¥—É–ª–µ–π

```mermaid
graph TD
    A[Telegram] -->|1. –°–æ–æ–±—â–µ–Ω–∏–µ| B[main.js]
    B -->|2. –ü–∞—Ä—Å–∏–Ω–≥| C[core/router.js]
    C -->|3. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞| D{message / callback?}
    
    D -->|message| E{–ö–æ–º–∞–Ω–¥–∞?}
    D -->|callback_query| F[core/state.js ‚Üí –æ–±—Ä–∞–±–æ—Ç–∫–∞]

    E -->|/start, /menu| G[modules/offline/menu.js]
    E -->|/create_new_menu| H[modules/online/generate_menu.js]
    E -->|/ask_ai| I[modules/online/ask_ai.js]

    G -->|–ß—Ç–µ–Ω–∏–µ| J[modules/sheets/crud.js]
    J -->|–î–∞–Ω–Ω—ã–µ| K[Google Sheets]

    H -->|–ì–µ–Ω–µ—Ä–∞—Ü–∏—è| L[modules/ai/adapter.js]
    L -->|AI (Gemini)| M[JSON-–æ—Ç–≤–µ—Ç]
    M -->|–ü–∞—Ä—Å–∏–Ω–≥| H
    H -->|–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ| J

    I -->|–°–µ—Å—Å–∏—è| N[core/state.js]
    N -->|–û–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞| O[modules/ai/adapter.js]

    P[modules/telegram/keyboard.js] -->|–ö–Ω–æ–ø–∫–∏| B
    Q[utils/markdown.js] -->|–≠–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ| R[modules/telegram/api.js]
    R -->|–û—Ç–≤–µ—Ç| A

    style A fill:#4CAF50, color:white
    style B fill:#2196F3, color:white
    style C fill:#1976D2, color:white
    style G fill:#FFC107, color:black
    style H fill:#FF9800, color:black
    style I fill:#F44336, color:white
    style J fill:#9C27B0, color:white
    style L fill:#E91E63, color:white
    style R fill:#00BCD4, color:white
```

---

## üèó –ö–ª—é—á–µ–≤—ã–µ —É–ª—É—á—à–µ–Ω–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### 1. **–ú–æ–¥—É–ª—å–Ω–æ—Å—Ç—å**
- –ö–∞–∂–¥—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç ‚Äî –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π.
- –õ–µ–≥–∫–æ –∑–∞–º–µ–Ω–∏—Ç—å AI-–∞–¥–∞–ø—Ç–µ—Ä –∏–ª–∏ Telegram-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.
### 2. **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º (State)**
–ü–æ–∑–≤–æ–ª—è–µ—Ç:
- –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å —Å–µ—Å—Å–∏–∏ (`/ask_ai` ‚Üí –æ–∂–∏–¥–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞).
- –ó–∞–ø–æ–º–∏–Ω–∞—Ç—å, –≤ –∫–∞–∫–æ–º –º–µ–Ω—é –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.
- –ò–∑–±–µ–≥–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö.

```javascript
// core/state.js
const UserState = {
  set(chatId, state) { PropertiesService.getUserProperties().setProperty(chatId, JSON.stringify(state)); },
  get(chatId) { return JSON.parse(PropertiesService.getUserProperties().getProperty(chatId) || "{}"); },
  clear(chatId) { PropertiesService.getUserProperties().deleteProperty(chatId); }
};
```

### 3. **–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π CRUD –¥–ª—è Google Sheets**

```javascript
// modules/sheets/crud.js
class SheetsCRUD {
  constructor(sheetName) {
    this.sheet = SpreadsheetApp.getActive().getSheetByName(sheetName);
  }

  read(range = "A1:Z1000") { return this.sheet.getRange(range).getValues(); }
  create(row) { this.sheet.appendRow(row); }
  update(range, data) { this.sheet.getRange(range).setValues(data); }
  delete(row) { this.sheet.deleteRow(row); }
  findBy(query) { /* –ø–æ–∏—Å–∫ –ø–æ —Å—Ç–æ–ª–±—Ü–∞–º */ }
}
```

### 4. **AI-–∞–¥–∞–ø—Ç–µ—Ä —Å JSON-–≤–∞–ª–∏–¥–∞—Ü–∏–µ–π**
–ì–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ AI –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –ø—Ä–∏–≥–æ–¥–Ω—ã–µ –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü—É.

### 5. **–û—Ñ–ª–∞–π–Ω-–º–æ–¥—É–ª–∏**
–ß–∏—Å—Ç—ã–µ, –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –æ—Ç AI, —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞–ø—Ä—è–º—É—é —Å Google Sheets.

### 6. **–û–Ω–ª–∞–π–Ω-–º–æ–¥—É–ª–∏**
–° –æ–±—Ä–∞–±–æ—Ç–∫–æ–π –æ—à–∏–±–æ–∫, –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º "–ø–µ—á–∞—Ç–∞–µ—Ç...", –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ —Ç–∞–±–ª–∏—Ü—É.

---

## üîÑ –°—Ü–µ–Ω–∞—Ä–∏–π: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –º–µ–Ω—é (–ø–æ–ª–Ω—ã–π –ø—É—Ç—å)

```mermaid
sequenceDiagram
    participant User
    participant Telegram
    participant SmartPit
    participant AI
    participant GoogleSheets

    User->>Telegram: /create_new_menu
    Telegram->>SmartPit: message.text
    SmartPit->>SmartPit: sendChatAction("typing")
    SmartPit->>AI: –ó–∞–ø—Ä–æ—Å –Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –º–µ–Ω—é
    AI-->>SmartPit: JSON —Å –º–µ–Ω—é
    SmartPit->>GoogleSheets: –ó–∞–ø–∏—Å—å –≤ –ª–∏—Å—Ç "Menu"
    SmartPit->>Telegram: "‚úÖ –ú–µ–Ω—é —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!"
    Telegram->>User: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
```

---

## ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ë—ã–ª–æ | –°—Ç–∞–ª–æ |
|--------|------|-------|
| –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å | –ù–∏–∑–∫–∞—è | –í—ã—Å–æ–∫–∞—è (–º–æ–¥—É–ª–∏) |
| –ü–æ–¥–¥–µ—Ä–∂–∫–∞ | –°–ª–æ–∂–Ω–∞—è | –ü—Ä–æ—Å—Ç–∞—è (–∫–∞–∂–¥—ã–π –º–æ–¥—É–ª—å —Å–∞–º –ø–æ —Å–µ–±–µ) |
| –û—à–∏–±–∫–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å | –ù–µ—Ç | –ï—Å—Ç—å (try/catch, –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ) |
| –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ | –ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ |
| –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è AI | –ñ—ë—Å—Ç–∫–æ –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∞ | –ß–µ—Ä–µ–∑ –∞–¥–∞–ø—Ç–µ—Ä |
| –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º | –ù–µ—Ç | –ï—Å—Ç—å |
| –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ | –¢—Ä—É–¥–Ω–æ | –ü—Ä–æ—Å—Ç–æ: –¥–æ–±–∞–≤—å –º–æ–¥—É–ª—å |

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. [ ] –°–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø–∞–ø–æ–∫
2. [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `core/router.js` –∏ `core/state.js`
3. [ ] –ù–∞—Å—Ç—Ä–æ–∏—Ç—å `config.js` —Å `TOKEN` –∏ `SHEET_ID`
4. [ ] –°–¥–µ–ª–∞—Ç—å `main.js` ‚Äî —Ç–æ—á–∫—É –≤—Ö–æ–¥–∞
5. [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `modules/telegram/api.js`
6. [ ] –î–æ–±–∞–≤–∏—Ç—å –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `PROJECT_PLAN.md`

---

> üìå **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞**: `2025-08-05`  
> üß† –†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ —Å —Ñ–æ–∫—É—Å–æ–º –Ω–∞ **–ø—Ä–æ—Å—Ç–æ—Ç—É, –Ω–∞–¥—ë–∂–Ω–æ—Å—Ç—å –∏ —É–¥–æ–±—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è**.

---

‚úÖ –≠—Ç–æ—Ç —Ñ–∞–π–ª –º–æ–∂–Ω–æ:
- –î–æ–±–∞–≤–∏—Ç—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π.
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å —á–µ—Ä–µ–∑ AI (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –∫–æ–º–º–∏—Ç–∞).

